<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WSDL 文件详解</title>
</head>
<link rel="stylesheet" type="text/css" href="../plugin/LanEditor/LanEditor.css"/>
<link rel="stylesheet" type="text/css" href="../plugin/LanEditor/highlight/styles/idea.css">

<link href="../plugin/SyntaxHighlighter/main.css" rel='stylesheet' type='text/css'>
<link href="../plugin/SyntaxHighlighter/shCore.css" rel='stylesheet' type='text/css'>
<link href="../plugin/SyntaxHighlighter/shThemeDefault.css" rel='stylesheet' type='text/css'>
<link href="../plugin/LanEditor/main.css" rel='stylesheet' type='text/css'>

<script src="../plugin/SyntaxHighlighter/shCore-convert.js" type='text/javascript'></script>
<script src="../plugin/SyntaxHighlighter/shBrushAll.js" type='text/javascript'></script>

<script type="text/javascript" src="../plugin/LanEditor/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="../plugin/LanEditor/LanEditor.js"></script>

<script type="text/javascript">
    $(document).ready(function () {
        //初始化 @textelem:编辑区的id @showelem可以省略
        var lan = LanEditor.init({
            textelem: "editor",
            showelem: "show"
        });
        //如果初始化失败，则显示出错信息
        if(lan.status == false){
            alter(lan.message);
            return ;
        }else{
            // 默认保存LanEditor快速指南文件
            // 获取文件创建的时间
            var createTime = LanEditor.Time.GetTimestamp();
            // 文件名
            LanEditor.File.CurOpenFile.name = $(document).attr("title");
            // 创建时间
            LanEditor.File.CurOpenFile.time = createTime;
            // 保存文件
            LanEditor.File.SaveFile();
            // 渲染
            LanEditor.RenderHTML();
        }
    });
</script>
<body>
<div id="edit">
    <textarea id="editor" name="editor">
#### WSDL 文件详解

 ``` http://localhost:8080/hello?wsdl ```
```xml

<?xml version='1.0' encoding='UTF-8'?>
<!-- Published by JAX-WS RI at http://jax-ws.dev.java.net. RI's version is JAX-WS RI 2.2.8 svn-revision#13980. -->
<!-- Generated by JAX-WS RI at http://jax-ws.dev.java.net. RI's version is JAX-WS RI 2.2.8 svn-revision#13980. -->
<definitions
        xmlns:wsu="http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd"
        xmlns:wsp="http://www.w3.org/ns/ws-policy"
        xmlns:wsp1_2="http://schemas.xmlsoap.org/ws/2004/09/policy"
        xmlns:wsam="http://www.w3.org/2007/05/addressing/metadata"
        xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/"
        xmlns:tns="http://ws.mrcuijt.science/"
        xmlns:xsd="http://www.w3.org/2001/XMLSchema"
        xmlns="http://schemas.xmlsoap.org/wsdl/"
        targetNamespace="http://ws.mrcuijt.science/"
        name="HelloWebServiceImplService">
    <types>
        <xsd:schema>
            <xsd:import namespace="http://ws.mrcuijt.science/" schemaLocation="http://localhost:8080/hello?xsd=1"/>
        </xsd:schema>
    </types>
    <message name="sayHello">
        <part name="parameters" element="tns:sayHello"/>
    </message>
    <message name="sayHelloResponse">
        <part name="parameters" element="tns:sayHelloResponse"/>
    </message>
    <portType name="HelloWebService">
        <operation name="sayHello">
            <input wsam:Action="http://ws.mrcuijt.science/HelloWebService/sayHelloRequest" message="tns:sayHello"/>
            <output wsam:Action="http://ws.mrcuijt.science/HelloWebService/sayHelloResponse" message="tns:sayHelloResponse"/>
        </operation>
    </portType>
    <binding name="HelloWebServicePortBinding" type="tns:HelloWebService">
        <soap:binding transport="http://schemas.xmlsoap.org/soap/http" style="document"/>
        <operation name="sayHello">
            <soap:operation soapAction=""/>
            <input>
                <soap:body use="literal"/>
            </input>
            <output>
                <soap:body use="literal"/>
            </output>
        </operation>
    </binding>
    <service name="HelloWebServiceImplService">
        <port name="HelloWebServicePort" binding="tns:HelloWebServicePortBinding">
            <soap:address location="http://localhost:8080/hello"/>
        </port>
    </service>
</definitions>
```
 ``` http://localhost:8080/hello?xsd=1 ```
```xml

<?xml version='1.0' encoding='UTF-8'?>
<!-- Published by JAX-WS RI at http://jax-ws.dev.java.net. RI's version is JAX-WS RI 2.2.8 svn-revision#13980. -->
<xs:schema
        xmlns:tns="http://ws.mrcuijt.science/"
        xmlns:xs="http://www.w3.org/2001/XMLSchema"
        version="1.0"
        targetNamespace="http://ws.mrcuijt.science/">
    <xs:element name="sayHello" type="tns:sayHello"/>
    <xs:element name="sayHelloResponse" type="tns:sayHelloResponse"/>
    <xs:complexType name="sayHello">
        <xs:sequence>
            <xs:element name="name" type="xs:string" minOccurs="0"/>
        </xs:sequence>
    </xs:complexType>
    <xs:complexType name="sayHelloResponse">
        <xs:sequence>
            <xs:element name="message" type="xs:string" minOccurs="0"/>
        </xs:sequence>
    </xs:complexType>
</xs:schema>
```

##### ``` <wsdl:definitions> ``` 元素：WSDL 文件的根元素

 ``` name ``` 属性：值为公开的 Web 服务的接口的实现类+Service

```java
name="HelloServiceImplService"
```

 ``` targetNamespace ``` 属性：指定目标名称空间。

 ``` targetNamespace ``` 的值被后面的 ``` xmlns:tns ``` 属性作为值，默认是使用接口实现类的包名的反缀。

```java
targetNamespace="http://ws.mrcuijt.science/"

xmlns:tns="http://ws.mrcuijt.science/"
```

##### ``` <wsdl:types> ``` 子元素
    注：这个元素会通过 <xs:element> 子元素声明几个复杂数据类型的元素。
       --> 对请求方法参数的声明的封装
       --> 对请求方法返回值的封装
###### 复杂数据类型元素的声明
```xml
<xs:element name="Customer" type="tns:customer"/>
```
 ```name``` 属性值是这个复杂类型的 JAXB 注解的 name 属性值

 ```type``` 属性是 tns:+JAXB 注解 name 属性值的全小写形式

 Customer 复杂类型，Customer 的@XMLRootElement 注解 name 属性的值

###### 请求方法参数封装的声明
```xml
<xs:element name="selectMaxAgeStudent"
            type="tns:selectMaxAgeStudent"/>
```
 ```name``` 属性值默认是接口中定义方法的名称

 ```type``` 属性值为 tns:+ name属性的值

 可以通过 ```@WebMethod``` 注解的 ```operationName``` 进行设置

###### 请求方法返回值封装的声明
```xml
<xs:element name="selectMaxAgeStudentResponse"
            type="tns:selectMaxAgeStudentResponse"/>
```
 ```name``` 属性值是与上面保持一致，XXXXResponse 方法名添加 Response 后缀

 ```type``` 属性值为 tns:+ name属性的值

##### ```<xs:complexType>``` 曾孙子元素
###### 对复杂类型声明的实现
```xml
<xs:complexType name="customer">
```
 ```name``` 属性值为，声明类型 ```name``` 属性值的全小写
```xml
    <!-- 字段类型的实现 -->
<xs:element minOccurs="0" name="age" type="xs:int"/>
<xs:element minOccurs="0" name="birthday" type="xs:dateTime"/>
<xs:element minOccurs="0" name="name" type="xs:string"/>
```

###### 对请求参数封装声明的实现
```xml
<xs:complexType name="selectMaxAgeStudent">
    <xs:sequence>
        <xs:element minOccurs="0" name="arg0" type="tns:customer"/>
        <xs:element minOccurs="0" name="arg1" type="tns:customer"/>
    </xs:sequence>
</xs:complexType>
```
 ```name``` 属性值为 ```arg0,arg1,arg...``` 可以通过 ```@WebParam``` 注解的 ```name``` 属性设值

 ```type``` 属性值，引用复杂类型的声明，或基础类型
###### 对方法返回值声明的实现
```xml
<xs:complexType name="selectMaxLongNameStudentResponse">
    <xs:sequence>
        <xs:element minOccurs="0" name="return" type="tns:customer"/>
    </xs:sequence>
</xs:complexType>
```
 ```name``` 属性默认值为 ```return``` 可以通过 ```@WebResult``` 注解的 ```name``` 属性值修改。

 ```type``` 属性值，引用复杂类型的声明，或基础类型

 JAX-WS 默认使用 ```ParameterStyle.WRAPPED``` 属性设置需要在返回结果中添加 ```<return>``` 元素，可以通过设置 ```parameterStyle = ParameterStyle.BARE``` 取消 ```<return>``` 元素。

```java
@SOAPBinding(style = Style.DOCUMENT,
             use = Use.LITERAL,
            parameterStyle = ParameterStyle.WRAPPED)
```

##### ```<wsdl:message>``` 元素

 &#160; &#160;这个元素将输入参数（方法参数）和响应结果（方法返回值）、受检查的异常信息包装为消息。

##### ```<wsdl:portType>``` 元素

 &#160; &#160;定义输入输出参数，并通过 message 属性绑定到之前声明的消息中。

 &#160; &#160;这个元素包含了一系列的 ```<wsdl:operation …>``` 子元素指定该端点服务包含了那些操作（方法），```<wsdl:operation …>```的子元素```<wsdl:input …>```、```<wsdl:output …>```指定操作的输入输出（通过属性 ```message``` 绑定到前面声明过的消息）。

#### 解析 WSDL

##### 解析思路

 - 从 ```portType``` 中找到 WebService 发布的服务 operation (input output fault)

 - 从 ```types```    中找到 WebService 发布的服务 operation (parameter name, parameter type)

 - 从 ```binding```  中找到 WebService 发布的服务 operation (input/output/fault types)

 - 从 ```service```  中找到 WebService 支持调用的协议 soap11 soap12 http GET/POST

##### 解析实现

```java
	// 创建 Service 服务对象
	public static Service getService(URL url) {
		WSDLParserUtil.url = url;
		QName qname = getServiceQName();
		if (qname == null) {
			logger.error("没有有效服务");
			return null;
		}
		Service service = Service.create(url, qname);
		return service;
	}
	// 获取 Web服务 访问的完整路径 (QName)
	private static QName getServiceQName() {
		try {
			SAXReader reader = new SAXReader();
			Document document = reader.read(url);
			// 读取服务根元素 definitions
			Element rootElem = document.getRootElement();
			// 读取服务命名空间 targetNamespace
			Attribute targetNamespace = rootElem.attribute("targetNamespace");
			logger.info(targetNamespace.getStringValue());
			// 读取 WebService 服务中的 service 元素获取可用服务名
			Element service = rootElem.element("service");
			if (service != null) {
				Attribute serviceName = service.attribute("name");
				logger.info(serviceName.getStringValue());
				return new QName(targetNamespace.getStringValue(), serviceName.getStringValue());
			}
		} catch (DocumentException e) {
			e.printStackTrace();
		}
		return null;
	}
	// 解析输出可用的 Service 服务名称(Service Port)
	private static void parseAvailableServicePort() {
		Service service = getService(url);
		if (service == null) {
			logger.error("没有有效服务");
			return;
		}
		// 可用服务名称集合
		Iterator<QName> iter = service.getPorts();
		while (iter.hasNext()) {
			QName q = iter.next();
			logger.info("{}", q);
		}
	}
	// 解析输出可用的 Service 服务方法（Service Method）
	private static void parseAvailableService() {
		try {
			SAXReader reader = new SAXReader();
			Document document = reader.read(url);
			Element rootElem = document.getRootElement();
			logger.info(rootElem.getName());
			// 读取 WebService 可用方法描述集合
			Element portType = rootElem.element("portType");
			logger.info(portType.getName());
			Iterator<Element> iter = portType.elementIterator();
			while (iter.hasNext()) {
				Element elem = iter.next();
				logger.info("{} \t {}", elem.getName(), elem.attribute("name").getValue());
			}
		} catch (DocumentException e) {
			e.printStackTrace();
		}
	}
```
##### 快速创建 WebService Client
```java
	public static void main(String[] args) {
		try {
			String endpoint = "";
			// WSDL 地址
			endpoint = "http://ws.webxml.com.cn/webservices/WeatherWebService.asmx?wsdl";
            // 创建 Service 服务对象
			Service service = WSDLParserUtil.getService(endpoint);
			// 创建 Web服务 访问的完整路径 (QName)
			QName protName = new QName("http://WebXml.com.cn/", "WeatherWebServiceSoap");
            // 创建 WebService Client
			WeatherWebServiceDemo client = service.getPort(protName, WeatherWebServiceDemo.class);
		} catch (MalformedURLException e) {
			e.printStackTrace();
		}
	}
```
    </textarea>
</div>

<div id="show"></div>
</body>
</html>