<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>javascript-basic-canvas-image-download2</title>
</head>
<link rel="stylesheet" type="text/css" href="../plugin/LanEditor/LanEditor.css"/>
<link rel="stylesheet" type="text/css" href="../plugin/LanEditor/highlight/styles/idea.css">

<link href="../plugin/SyntaxHighlighter/main.css" rel='stylesheet' type='text/css'>
<link href="../plugin/SyntaxHighlighter/shCore.css" rel='stylesheet' type='text/css'>
<link href="../plugin/SyntaxHighlighter/shThemeDefault.css" rel='stylesheet' type='text/css'>
<link href="../plugin/LanEditor/main.css" rel='stylesheet' type='text/css'>

<script src="../plugin/SyntaxHighlighter/shCore-convert.js" type='text/javascript'></script>
<script src="../plugin/SyntaxHighlighter/shBrushAll.js" type='text/javascript'></script>

<script type="text/javascript" src="../plugin/LanEditor/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="../plugin/LanEditor/LanEditor.js"></script>

<script type="text/javascript">
    $(document).ready(function () {
        //初始化 @textelem:编辑区的id @showelem可以省略
        var lan = LanEditor.init({
            textelem: "editor",
            showelem: "show"
        });
        //如果初始化失败，则显示出错信息
        if(lan.status == false){
            alter(lan.message);
            return ;
        }else{
            // 默认保存LanEditor快速指南文件
            // 获取文件创建的时间
            var createTime = LanEditor.Time.GetTimestamp();
            // 文件名
            LanEditor.File.CurOpenFile.name = $(document).attr("title");
            // 创建时间
            LanEditor.File.CurOpenFile.time = createTime;
            // 保存文件
            LanEditor.File.SaveFile();
            // 渲染
            LanEditor.RenderHTML();
        }
    });
</script>
<body>
<div id="edit">
    <textarea id="editor" name="editor">
#### javascript-basic-canvas-image-download2

MAX 268850 2~20
MAX 220980 10

雪女与诅咒戒指s2-1 427111 184
雪女与诅咒戒指s2-2 427152 92
雪女与诅咒戒指s2-3 427157 92

雪女与诅咒戒指s1-1 399054 72

https://github.com/anthonycr/Lightning-Browser.git

https://18comic.vip/album/391690/班裡的優等生，一臉淫蕩地被幹到高潮

https://18comic.vip/album/389788/被哥布林做了色色的事

https://18comic.vip/album/339033/后宫露营 

https://18comic.vip/album/235900/雙胞胎的食譜

https://18comic.vip/album/322938/異世界催眠王

https://18comic.vip/album/335971/委員長の催

Kのアソコをたった1枚で奴隷に～ 181193 608

[双龍]这样的比较好001
1 287234 100
61 357027 100
62 357028 100

220951

魅魔学园的狗 400319
催眠软件是无效的 410858
求求你給我能量 423216
哀嘆的艾莉西亞 444046

某放送局アナウンサー九条愉理子のアイとアナ2 349585 188
[SPY×FAMILY]優雅的性 349664 22
無表情で抜いてくれる病 353607 117
女武神与舰长的千层博弈 350629 40
高評価よろしくお願いします 354814 48
新妻寝取 358318 209
偶像部 226784 300?
性女淫説 219720 198
あまとろ性活 302736 183
私、叔父、母 348893 79

[多摩豪]義弟が私を女にする 244956 110
[多摩豪]在新幹線上做什麼啦 150584 71
[多摩豪]壊された田舎妻 1637 65
[多摩豪]隣人相姦 87973 80
[多摩豪]息子の性処理道具 118290 76
[多摩豪]制裁を 77316 50
[多摩豪]何も知らない 44150 109
[多摩豪]狙われた眼鏡地味妻 167263 85
人妻倶楽部 62531 95
人妻達の危険な情事 13315 93
濡れ透けLOVE×2 25507 141
人妻にラブレターを送ってみた 4824 300?

人妻と巨漢 79013 83
[多摩豪]椿ヶ丘団地の管理人1 157 114
[多摩豪]椿ヶ丘団地の管理人2 155 94
[多摩豪]デキる女上司 156 79
[多摩豪]デキる女上司番外 121813 84



[FGO]性の子種集め 118437 23
[FGO]OrangeMaru_Special_08 104198 34
[FGO]Moon_Phase_Material2 113306 30
[FGO]清姫と溫泉 103887 18
[FGO]外の世界 104196 23
[FGO]頭の中はHな妄想 124262 24
[FGO]Carnal_Chaldea5 314680 16
[FGO]温泉は無限の肉 306335 39
[FGO]FGOPPAI_BEAST 97103 19
[FGO]黑貞德Comic 305417 18



[FGO]尋問調書 96355 22
[FGO]タマモと溫泉旅行 93943 20
[FGO]生意気後輩 86849 26
[FGO]HappyBirthday 135758 11

[FGO]高圧的紫式部 342836 33
[FGO]師匠 315479 16
[FGO]姉ズリレッスン 314876 22

[FGO]けんじゃたいむ5 305415 17
[FGO]けんじゃたいむ4 305416 18
[FGO]けんじゃたいむ3 305414 19
[FGO]けんじゃたいむ2 305412 32
[FGO]けんじゃたいむ1 305403 30
[FGO]けんじゃたいむ0 304765 18

[MANA]八重神子1 326271 6
[MANA]八重神子2 329977 17
[MANA]八重神子3 331767 18
[MANA]八重神子4 333679 17

[MANA]申鶴1 305957 6
[MANA]申鶴2 308329 11
[MANA]申鶴3 309838 12
[MANA]申鶴4 314180 16


[MANA]甘雨1 294555 7
[MANA]甘雨2 295978 26
[MANA]甘雨3 297237 11
[MANA]甘雨4 300726 11
[MANA]甘雨5 304759 21

[MANA]胡桃1 292306 7
[MANA]胡桃2 292258 16
[MANA]胡桃3 293255 19

[坂上海]辣妹診所 358984 86
358984 86 2022-07-12
358602 199 2022-07-11
341884 221 2022-05-17


```js
var $body = document.createElement("body");
document.body = $body;
var $wrapper = document.createElement("div");
$wrapper.id = "wrapper";
document.body.appendChild($wrapper);
function loadScript(){
  var $wrapper = document.getElementById("wrapper");
  var $script = document.createElement("script");
  $script.src = "https://127.0.0.1:8443/jquery.js";
  $wrapper.appendChild($script);
}
loadScript();

var basePath = "https://18comic.vip/media/photos/##/";
//var basePath = "https://cdn-msp.18comic.org/media/photos/##/";
function init(){
  /* $btnOne */
  var $btnOne = document.createElement("button");
  $btnOne.id = "btnOne";
  $btnOne.innerText = "First";

  /* $btnPre */
  var $btnPre = document.createElement("button");
  $btnPre.id = "btnPre";
  $btnPre.innerText = "Preview";

  /* $btnNex */
  var $btnNex = document.createElement("button");
  $btnNex.id = "btnNex";
  $btnNex.innerText = "Next";

  /* $btnDown */
  var $btnDown = document.createElement("button");
  $btnDown.id = "btnDown";
  $btnDown.innerText = "Download";

  /* $tips */
  var $tips = document.createElement("div");
  $tips.id = "tips";
  $tips.innerText = "TIPS:";

  /* $img */
  var $img = document.createElement("img");
  $img.onload = function(e){
    console.info(e);
    console.info(e.target);
    drawCanvas();
  }

  /* $canvas */
  var $canvas = document.createElement("canvas");

  /* $a */
  var $a = document.createElement("a");
  $a.innerText = "aaaa";

  /* TOOLS INIT */
  $("#wrapper").prepend($img);
  $("#wrapper").prepend($canvas);
  $("#wrapper").prepend($tips);
  $("#wrapper").prepend($a);
  $("#wrapper").prepend($btnDown);
  $("#wrapper").prepend($btnNex);
  $("#wrapper").prepend($btnPre);
  $("#wrapper").prepend($btnOne);

  window.$a=$a;
  window.$img=$img;
  window.$canvas=$canvas;
  window.$tips=$tips;
  window.$btnDown=$btnDown;
  window.$btnNex=$btnNex;
  window.$btnPre=$btnPre;
  window.$btnOne=$btnOne;

}

function loadImage(blobURL){
  try{
    window.URL.revokeObjectURL(blobURL);
  } catch(e){
    console.info(e.message)
  }
  if(index + 1 > arrys.length) return;
  $($img).attr("src", path(aid) + arrys[index][1]).attr("num", arrys[index][2]);
  index++;
}

function drawCanvas(){
  $canvas.width = $img.width;
  $canvas.height = $img.height;
  var tempctx;
  if(!window.tempctx)
    tempctx = $canvas.getContext("2d");
  else
    tempctx = window.tempctx;
  tempctx.clearRect(0, 0, $img.width,$img.height);
  var s_w=$img.width;
  var w=$img.naturalWidth;
  var h=$img.naturalHeight;
  if(s_w>$img.parentNode.offsetWidth||s_w==0){
    s_w=$img.parentNode.offsetWidth;
  }
  var num=$img.getAttribute("num");
  var remainder=parseInt(h%num);
  var copyW=w;
  for(var i=0; i < num;i++){
    var copyH=Math.floor(h/num);
    var py=copyH*(i);
    var y=h-(copyH*(i+1))-remainder;
    if(i==0){
      copyH=copyH+remainder;
    }else{
      py=py+remainder;
    }
    tempctx.drawImage($img,0,y,copyW,copyH,0,py,copyW,copyH);
  }
  var obj = {};
  var cblobUrl = $canvas.toDataURL("image/jpeg").replace("image/jpeg", "image/octet-stream");
  obj.name = getFileName($img.src);
  obj.url = cblobUrl;
  $($a).attr("href", obj.url).attr("download", obj.name).html("aaaaa" + obj.name);
  $($a)[0].click();
  window.tempctx=tempctx;
  setTimeout(function(){ loadImage(cblobUrl); }, "800");
}

function path(aid){
  return window.basePath.replace("##", aid);
}

function getFileName(url){
  if(!url) return "NULL";
  if(url.lastIndexOf("?") > 0) url = url.substring(0, url.lastIndexOf("?"));
  if(url.endsWith("/")) url = url.substring(0, url.length - 1);
  var fileName = url.substring(url.lastIndexOf("/") + 1);
  fileName = fileName.substring(0, fileName.lastIndexOf("."));
  fileName += ".jpg";
  return fileName;
}
init();
function loadImage(blobURL){
  try{
    window.URL.revokeObjectURL(blobURL);
  } catch(e){
    console.info(e.message)
  }
  if(index + 1 > arrys.length) return;
  $($img).attr("src", path(aid) + arrys[index][1]).attr("num", arrys[index][2]);
  index++;
}

function drawCanvas(){
  $canvas.width = $img.width;
  $canvas.height = $img.height;
  var tempctx;
  if(!window.tempctx)
    tempctx = $canvas.getContext("2d");
  else
    tempctx = window.tempctx;
  tempctx.clearRect(0, 0, $img.width,$img.height);
  var s_w=$img.width;
  var w=$img.naturalWidth;
  var h=$img.naturalHeight;
  if(s_w>$img.parentNode.offsetWidth||s_w==0){
    s_w=$img.parentNode.offsetWidth;
  }
  var num=$img.getAttribute("num");
  var remainder=parseInt(h%num);
  var copyW=w;
  for(var i=0; i < num;i++){
    var copyH=Math.floor(h/num);
    var py=copyH*(i);
    var y=h-(copyH*(i+1))-remainder;
    if(i==0){
      copyH=copyH+remainder;
    }else{
      py=py+remainder;
    }
    tempctx.drawImage($img,0,y,copyW,copyH,0,py,copyW,copyH);
  }
  var name = getFileName($img.src);
  $($a).html("aaaaa" + name);
  $canvas.toBlob(function(blob){
    var f = new File([blob], name, {type:blob.type});
    console.info(f);

    var form = new FormData();
    form.append("file", f);

    var xhr = new XMLHttpRequest();
    xhr.open("post", "https://127.0.0.1:8443/upload", true);
    xhr.onload = function(){
      console.info("---end");
      setTimeout(function(){ loadImage(); }, "800");
    }
    xhr.send(form);
  }, "image/jpeg");
  window.tempctx=tempctx;
  //setTimeout(function(){ loadImage(cblobUrl); }, "800");
}
```


**注：仅允许同源请求图片和支持跨域资源共享图片**

##### 公共函数定义

 - 加载 JQuery

```js
function loadScript(){
  var $wrapper = document.getElementById("wrapper");
  var $script = document.createElement("script");
  $script.src = "https://127.0.0.1:8443/jquery.js";
  $wrapper.appendChild($script);
}
loadScript();
```

```js
var $body = document.createElement("body");
document.body = $body;
```

```js
var $wrapper = document.createElement("div");
$wrapper.id = "wrapper";
document.body.appendChild($wrapper);
```


```js
var basePath = "https://18comic.vip/media/photos/##/";
//var basePath = "https://cdn-msp.18comic.org/media/photos/##/";
function init(){
  /* $btnOne */
  var $btnOne = document.createElement("button");
  $btnOne.id = "btnOne";
  $btnOne.innerText = "First";

  /* $btnPre */
  var $btnPre = document.createElement("button");
  $btnPre.id = "btnPre";
  $btnPre.innerText = "Preview";

  /* $btnNex */
  var $btnNex = document.createElement("button");
  $btnNex.id = "btnNex";
  $btnNex.innerText = "Next";

  /* $btnDown */
  var $btnDown = document.createElement("button");
  $btnDown.id = "btnDown";
  $btnDown.innerText = "Download";

  /* $tips */
  var $tips = document.createElement("div");
  $tips.id = "tips";
  $tips.innerText = "TIPS:";

  /* $img */
  var $img = document.createElement("img");
  $img.onload = function(e){
    console.info(e);
    console.info(e.target);
    drawCanvas();
  }

  /* $canvas */
  var $canvas = document.createElement("canvas");

  /* $a */
  var $a = document.createElement("a");
  $a.innerText = "aaaa";

  /* TOOLS INIT */
  $("#wrapper").prepend($img);
  $("#wrapper").prepend($canvas);
  $("#wrapper").prepend($tips);
  $("#wrapper").prepend($a);
  $("#wrapper").prepend($btnDown);
  $("#wrapper").prepend($btnNex);
  $("#wrapper").prepend($btnPre);
  $("#wrapper").prepend($btnOne);

  window.$a=$a;
  window.$img=$img;
  window.$canvas=$canvas;
  window.$tips=$tips;
  window.$btnDown=$btnDown;
  window.$btnNex=$btnNex;
  window.$btnPre=$btnPre;
  window.$btnOne=$btnOne;

}

function loadImage(blobURL){
  try{
    window.URL.revokeObjectURL(blobURL);
  } catch(e){
    console.info(e.message)
  }
  if(index + 1 > arrys.length) return;
  $($img).attr("src", path(aid) + arrys[index][1]).attr("num", arrys[index][2]);
  index++;
}

function drawCanvas(){
  $canvas.width = $img.width;
  $canvas.height = $img.height;
  var tempctx;
  if(!window.tempctx)
    tempctx = $canvas.getContext("2d");
  else
    tempctx = window.tempctx;
  tempctx.clearRect(0, 0, $img.width,$img.height);
  var s_w=$img.width;
  var w=$img.naturalWidth;
  var h=$img.naturalHeight;
  if(s_w>$img.parentNode.offsetWidth||s_w==0){
    s_w=$img.parentNode.offsetWidth;
  }
  var num=$img.getAttribute("num");
  var remainder=parseInt(h%num);
  var copyW=w;
  for(var i=0; i < num;i++){
    var copyH=Math.floor(h/num);
    var py=copyH*(i);
    var y=h-(copyH*(i+1))-remainder;
    if(i==0){
      copyH=copyH+remainder;
    }else{
      py=py+remainder;
    }
    tempctx.drawImage($img,0,y,copyW,copyH,0,py,copyW,copyH);
  }
  var obj = {};
  var cblobUrl = $canvas.toDataURL("image/jpeg").replace("image/jpeg", "image/octet-stream");
  obj.name = getFileName($img.src);
  obj.url = cblobUrl;
  $($a).attr("href", obj.url).attr("download", obj.name).html("aaaaa" + obj.name);
  $($a)[0].click();
  window.tempctx=tempctx;
  setTimeout(function(){ loadImage(cblobUrl); }, "800");
}

function path(aid){
  return window.basePath.replace("##", aid);
}

function getFileName(url){
  if(!url) return "NULL";
  if(url.lastIndexOf("?") > 0) url = url.substring(0, url.lastIndexOf("?"));
  if(url.endsWith("/")) url = url.substring(0, url.length - 1);
  var fileName = url.substring(url.lastIndexOf("/") + 1);
  return fileName;
}
init();
```

```js
var index = 0;
var aid = "342917";
var arrys = [{0:'00001',1:'00001.jpg',2:'18'}];
```

```js
var index = 0;
var aid = "265123";
var arrys = [{0:'00001',1:'00001.jpg',2:'20'},{0:'00002',1:'00002.jpg',2:'18'}]
loadImage();
```

```js
function loadImage(blobURL){
  try{
    window.URL.revokeObjectURL(blobURL);
  } catch(e){
    console.info(e.message)
  }
  if(index + 1 > arrys.length) return;
  $($img).attr("src", path(aid) + arrys[index][1]).attr("num", arrys[index][2]);
  index++;
}

function drawCanvas(){
  $canvas.width = $img.width;
  $canvas.height = $img.height;
  var tempctx;
  if(!window.tempctx)
    tempctx = $canvas.getContext("2d");
  else
    tempctx = window.tempctx;
  tempctx.clearRect(0, 0, $img.width,$img.height);
  var s_w=$img.width;
  var w=$img.naturalWidth;
  var h=$img.naturalHeight;
  if(s_w>$img.parentNode.offsetWidth||s_w==0){
    s_w=$img.parentNode.offsetWidth;
  }
  var num=$img.getAttribute("num");
  var remainder=parseInt(h%num);
  var copyW=w;
  for(var i=0; i < num;i++){
    var copyH=Math.floor(h/num);
    var py=copyH*(i);
    var y=h-(copyH*(i+1))-remainder;
    if(i==0){
      copyH=copyH+remainder;
    }else{
      py=py+remainder;
    }
    tempctx.drawImage($img,0,y,copyW,copyH,0,py,copyW,copyH);
  }
  var name = getFileName($img.src);
  $($a).html("aaaaa" + name);
  $canvas.toBlob(function(blob){
    name = name.replace(".webp", ".jpg");
    var f = new File([blob], name, {type:blob.type});
    console.info(f);

    var form = new FormData();
    form.append("file", f);

    var xhr = new XMLHttpRequest();
    xhr.open("post", "https://127.0.0.1:8443/upload", true);
    xhr.onload = function(){
      console.info("---end");
      setTimeout(function(){ loadImage(); }, "800");
    }
    xhr.send(form);
  }, "image/jpeg");
  window.tempctx=tempctx;
  //setTimeout(function(){ loadImage(cblobUrl); }, "800");
}
```

```js
function loadImage(blobURL){
  try{
    window.URL.revokeObjectURL(blobURL);
  } catch(e){
    console.info(e.message)
  }
  if(index + 1 > arrys.length) return;
  $($img).attr("src", path(aid) + arrys[index][1]).attr("num", arrys[index][2]);
  index++;
}

function drawCanvas(){
  $canvas.width = $img.width;
  $canvas.height = $img.height;
  var tempctx;
  if(!window.tempctx)
    tempctx = $canvas.getContext("2d");
  else
    tempctx = window.tempctx;
  tempctx.clearRect(0, 0, $img.width,$img.height);
  tempctx.drawImage($img, 0, 0, $img.width, $img.height);
  var name = getFileName($img.src);
  $($a).html("aaaaa" + name);
  $canvas.toBlob(function(blob){
    name = name.replace(".webp", ".jpg");
    var f = new File([blob], name, {type:blob.type});
    console.info(f);

    var form = new FormData();
    form.append("file", f);

    var xhr = new XMLHttpRequest();
    xhr.open("post", "https://127.0.0.1:8443/upload", true);
    xhr.onload = function(){
      console.info("---end");
      setTimeout(function(){ loadImage(); }, "800");
    }
    xhr.send(form);
  }, "image/jpeg");
  window.tempctx=tempctx;
}
```

```js
var temps = [];
var errors = [33];
function ers(errors, arrys){
  var c1 = 1;
  var ers = [];
  for(var i = 0; i < errors.length; i++){
    ers[i] = arrys[errors[i] - c1];
  }
  console.info(ers);
  return ers;
}
var result = ers(errors, arrys);
temps = arrys;
arrys = result;

loadImage();
```
	</textarea>
</div>

<div id="show"></div>
</body>
</html>