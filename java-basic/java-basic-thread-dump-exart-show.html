<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><style type="text/css">h1,h2,h3,h4,h5,h6,p,blockquote{margin:0;padding:0}body{font-family:"Helvetica Neue",Helvetica,"Hiragino Sans GB",Arial,sans-serif;font-size:13px;line-height:18px;color:#737373;margin:10px 13px 10px 13px}a{color:#0069d6}a:hover{color:#0050a3;text-decoration:none}a img{border:0}p{margin-bottom:9px}h1,h2,h3,h4,h5,h6{color:#404040;line-height:36px}h1{margin-bottom:18px;font-size:30px}h2{font-size:24px}h3{font-size:18px}h4{font-size:16px}h5{font-size:14px}h6{font-size:13px}hr{margin:0 0 19px;border:0;border-bottom:1px solid #ccc}blockquote{padding:13px 13px 21px 15px;margin-bottom:18px;font-family:georgia,serif;font-style:italic}blockquote:before{content:"C";font-size:40px;margin-left:-10px;font-family:georgia,serif;color:#eee}blockquote p{font-size:14px;font-weight:300;line-height:18px;margin-bottom:0;font-style:italic}code,pre{font-family:Monaco,Andale Mono,Courier New,monospace}code{background-color:#fee9cc;color:rgba(0,0,0,0.75);padding:1px 3px;font-size:12px;-webkit-border-radius:3px;-moz-border-radius:3px;border-radius:3px}pre{display:block;padding:14px;margin:0 0 18px;line-height:16px;font-size:11px;border:1px solid #d9d9d9;white-space:pre-wrap;word-wrap:break-word}pre code{background-color:#fff;color:#737373;font-size:11px;padding:0}@media screen and (min-width:768px){body{width:748px;margin:10px auto}}body{font-family:Helvetica,Geneva,Arial,sans-serif;font-size:1em;font-style:normal;font-weight:400;color:#333;background-color:#fff;line-height:2em}body.with_sponsor{margin-right:410px}a{color:#5a86e4;text-decoration:none}a:hover{text-decoration:underline}a.external,a[href*="//"]:not([href*="alexgorbatchev.com"]){background:url(external.png) right 50% no-repeat;padding-right:12px}.file-list,code,pre{font-family:Consolas,Monaco,"Bitstream Vera Sans Mono","Courier New",Courier,monospace}table{-moz-border-radius:5px;-webkit-border-radius:5px 5px 5px 5px;border:2px solid #adadad;padding:.5em;width:100%}table td,table th{padding:.3em .5em;vertical-align:top}table th{text-align:left}table tbody>tr:hover{background:#cbe2ff;-moz-border-radius:3px;-webkit-border-radius:3px 3px 3px 3px}table tbody>tr>td:first-child{white-space:nowrap}#clear{clear:both}#title h1{font-weight:700;font-size:4em;color:#adadad;margin:0;line-height:100%}#title h1 #whatsnew{display:inline}#title h1 #whatsnew a{font-size:.5em;color:red}#title h2{font-size:1.45em}#title #forkme{display:block;position:fixed;z-index:5;top:0;left:0;border:0;background:url(forkme.png) no-repeat;width:149px;height:149px;text-indent:-1000px;overflow:hidden}#content .date,#content .version,.badge{-moz-border-radius:3px;-webkit-border-radius:3px 3px 3px 3px;font-size:10px;font-weight:400;padding:3px 5px 4px;line-height:100%;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}#content .sponsor,#theme-example{-moz-border-radius:5px;-webkit-border-radius:5px 5px 5px 5px}#content #news ul{list-style-type:none;margin:0;padding:0}#content #news ul li{position:relative;display:block;padding-left:7em;min-height:22px}#blurb,#content .date,#footer,#meta,.float{position:absolute;width:10em;text-align:right}#content .date{background:#cbe2ff;color:#5a86e4;height:20px;left:0;top:0;padding:6px 5px 0}#content .version{background:#adadad;color:#fff}#content h3{margin:1.5em 0 .5em;font-size:1.45em}#content h2>a[name]{color:#000;text-decoration:none}#content .sponsor{padding:.1em 1em;background:#feffcb;margin-bottom:1em}#footer,#sponsor{-moz-border-radius:3px;-webkit-border-radius:3px 3px 3px 3px}#content li>p:only-child{margin:0}#blurb,#footer,#meta,.float{top:10px;right:10px;padding:1em;line-height:1.1em}#blurb a,#footer a,#meta a,.float a{display:block}.with_sponsor #blurb,.with_sponsor #footer,.with_sponsor #meta,.with_sponsor .float{right:190px}#sponsor{position:fixed;top:10px;right:10px;bottom:10px;background:#6380EA}#sponsor a{padding:0;background:0 0}#meta{z-index:2;font-weight:700;padding-top:7em}#footer{background:#cbe2ff;padding-top:14em;z-index:1}#footer #ad{margin-bottom:.5em}#blurb{text-align:left;z-index:2}#blurb a{display:inline}#blurb em{font-size:80%}#copyright{color:#adadad;font-size:1.2em;margin-top:3em}#theme-example{padding:1em 2em;background-color:#adadad}.code>.container>.line,.code>.container>.line>.java,.code>.container>.line>.js,.code>.container>.line>code,.gutter>.line{height:14px!important;line-height:14px!important;font-size:14px!important;font-family:"courier new"!important}#code_source{border:1px solid #ccc;width:998px;height:200px}#code_type{width:170px;border:1px solid #bbb;height:28px;line-height:28px}.syntaxhighlighter .comments,.syntaxhighlighter .comments a,.syntaxhighlighter .plain,.syntaxhighlighter .plain a,.syntaxhighlighter .string,.syntaxhighlighter .string a{height:14px!important;line-height:14px!important;font-size:14px!important;font-family:"courier new"!important}.syntaxhighlighter .plain,.syntaxhighlighter .plain a{color:#000!important}.syntaxhighlighter a,.syntaxhighlighter code,.syntaxhighlighter div,.syntaxhighlighter table,.syntaxhighlighter table caption,.syntaxhighlighter table tbody,.syntaxhighlighter table td,.syntaxhighlighter table thead,.syntaxhighlighter table tr,.syntaxhighlighter textarea{-moz-border-radius:0!important;-webkit-border-radius:0!important;background:0 0!important;border:0!important;bottom:auto!important;float:none!important;height:auto!important;left:auto!important;line-height:1.1em!important;margin:0!important;outline:0!important;overflow:visible!important;padding:0!important;position:static!important;right:auto!important;text-align:left!important;top:auto!important;vertical-align:baseline!important;width:auto!important;box-sizing:content-box!important;font-family:Consolas,"Bitstream Vera Sans Mono","Courier New",Courier,monospace!important;font-weight:400!important;font-style:normal!important;font-size:1em!important;min-height:inherit!important;min-height:auto!important}.syntaxhighlighter,.syntaxhighlighter table td.code .container{position:relative!important}.syntaxhighlighter,.syntaxhighlighter table,.syntaxhighlighter table td.code{width:100%!important}.syntaxhighlighter .bold,.syntaxhighlighter.printing .script{font-weight:700!important}.syntaxhighlighter{margin:1em 0!important;overflow:auto!important;font-size:1em!important}.syntaxhighlighter.source{overflow:hidden!important}.syntaxhighlighter .italic{font-style:italic!important}.syntaxhighlighter .line{white-space:pre!important}.syntaxhighlighter table caption{text-align:left!important;padding:.5em 0 .5em 1em!important}.syntaxhighlighter table td.code .container textarea{box-sizing:border-box!important;position:absolute!important;left:0!important;top:0!important;width:100%!important;height:100%!important;border:none!important;background:#fff!important;padding-left:1em!important;overflow:hidden!important;white-space:pre!important}.syntaxhighlighter table td.gutter .line{text-align:right!important;padding:0 .5em 0 1em!important}.syntaxhighlighter table td.code .line{padding:0 1em!important}.syntaxhighlighter.nogutter td.code .container textarea,.syntaxhighlighter.nogutter td.code .line{padding-left:0!important}.syntaxhighlighter.show{display:block!important}.syntaxhighlighter.collapsed table{display:none!important}.syntaxhighlighter.collapsed .toolbar{padding:.1em .8em 0!important;font-size:1em!important;position:static!important;width:auto!important;height:auto!important}.syntaxhighlighter.collapsed .toolbar span{display:inline!important;margin-right:1em!important}.syntaxhighlighter.collapsed .toolbar span a{padding:0!important;display:none!important}.syntaxhighlighter .toolbar span.title,.syntaxhighlighter.collapsed .toolbar span a.expandSource{display:inline!important}.syntaxhighlighter .toolbar{position:absolute!important;right:1px!important;top:1px!important;width:11px!important;height:11px!important;font-size:10px!important;z-index:10!important}.syntaxhighlighter .toolbar a{display:block!important;text-align:center!important;text-decoration:none!important;padding-top:1px!important}.syntaxhighlighter .toolbar a.expandSource,.syntaxhighlighter.printing .toolbar{display:none!important}.syntaxhighlighter.ie{font-size:.9em!important;padding:1px 0!important}.syntaxhighlighter.ie .toolbar{line-height:8px!important}.syntaxhighlighter.ie .toolbar a{padding-top:0!important}.syntaxhighlighter.printing .line.alt1 .content,.syntaxhighlighter.printing .line.alt2 .content,.syntaxhighlighter.printing .line.highlighted .number,.syntaxhighlighter.printing .line.highlighted.alt1 .content,.syntaxhighlighter.printing .line.highlighted.alt2 .content{background:0 0!important}.syntaxhighlighter.printing .line .number{color:#bbb!important}.syntaxhighlighter.printing .line .content,.syntaxhighlighter.printing .plain,.syntaxhighlighter.printing .plain a{color:#000!important}.syntaxhighlighter.printing a{text-decoration:none!important}.syntaxhighlighter.printing .comments,.syntaxhighlighter.printing .comments a{color:#008200!important}.syntaxhighlighter.printing .string,.syntaxhighlighter.printing .string a{color:#00f!important}.syntaxhighlighter.printing .keyword{color:#069!important;font-weight:700!important}.syntaxhighlighter.printing .preprocessor{color:gray!important}.syntaxhighlighter.printing .variable{color:#a70!important}.syntaxhighlighter.printing .value{color:#090!important}.syntaxhighlighter.printing .functions{color:#ff1493!important}.syntaxhighlighter.printing .constants{color:#06c!important}.syntaxhighlighter.printing .color1,.syntaxhighlighter.printing .color1 a{color:gray!important}.syntaxhighlighter.printing .color2,.syntaxhighlighter.printing .color2 a{color:#ff1493!important}.syntaxhighlighter.printing .color3,.syntaxhighlighter.printing .color3 a{color:red!important}.syntaxhighlighter.printing .break,.syntaxhighlighter.printing .break a{color:#000!important}.syntaxhighlighter a,.syntaxhighlighter code,.syntaxhighlighter div,.syntaxhighlighter table,.syntaxhighlighter table caption,.syntaxhighlighter table tbody,.syntaxhighlighter table td,.syntaxhighlighter table thead,.syntaxhighlighter table tr,.syntaxhighlighter textarea{-moz-border-radius:0!important;-webkit-border-radius:0!important;background:0 0!important;border:0!important;bottom:auto!important;float:none!important;height:auto!important;left:auto!important;line-height:1.1em!important;margin:0!important;outline:0!important;overflow:visible!important;padding:0!important;position:static!important;right:auto!important;text-align:left!important;top:auto!important;vertical-align:baseline!important;width:auto!important;box-sizing:content-box!important;font-family:Consolas,"Bitstream Vera Sans Mono","Courier New",Courier,monospace!important;font-weight:400!important;font-style:normal!important;font-size:1em!important;min-height:inherit!important;min-height:auto!important}.syntaxhighlighter,.syntaxhighlighter table td.code .container{position:relative!important}.syntaxhighlighter,.syntaxhighlighter table,.syntaxhighlighter table td.code{width:100%!important}.syntaxhighlighter .bold,.syntaxhighlighter .keyword,.syntaxhighlighter .script,.syntaxhighlighter.printing .script{font-weight:700!important}.syntaxhighlighter{margin:1em 0!important;overflow:auto!important;font-size:1em!important}.syntaxhighlighter.source{overflow:hidden!important}.syntaxhighlighter .italic{font-style:italic!important}.syntaxhighlighter .line{white-space:pre!important}.syntaxhighlighter table caption{text-align:left!important;padding:.5em 0 .5em 1em!important}.syntaxhighlighter table td.code .container textarea{box-sizing:border-box!important;position:absolute!important;left:0!important;top:0!important;width:100%!important;height:100%!important;border:none!important;background:#fff!important;padding-left:1em!important;overflow:hidden!important;white-space:pre!important}.syntaxhighlighter table td.gutter .line{text-align:right!important;padding:0 .5em 0 1em!important}.syntaxhighlighter table td.code .line{padding:0 1em!important}.syntaxhighlighter.nogutter td.code .container textarea,.syntaxhighlighter.nogutter td.code .line{padding-left:0!important}.syntaxhighlighter.show{display:block!important}.syntaxhighlighter.collapsed table{display:none!important}.syntaxhighlighter.collapsed .toolbar{padding:.1em .8em 0!important;font-size:1em!important;position:static!important;width:auto!important;height:auto!important}.syntaxhighlighter.collapsed .toolbar span{display:inline!important;margin-right:1em!important}.syntaxhighlighter.collapsed .toolbar span a{padding:0!important;display:none!important}.syntaxhighlighter .toolbar span.title,.syntaxhighlighter.collapsed .toolbar span a.expandSource{display:inline!important}.syntaxhighlighter .toolbar{position:absolute!important;right:1px!important;top:1px!important;width:11px!important;height:11px!important;font-size:10px!important;z-index:10!important}.syntaxhighlighter .toolbar a{display:block!important;text-align:center!important;text-decoration:none!important;padding-top:1px!important}.syntaxhighlighter .toolbar a.expandSource,.syntaxhighlighter.printing .toolbar{display:none!important}.syntaxhighlighter.ie{font-size:.9em!important;padding:1px 0!important}.syntaxhighlighter.ie .toolbar{line-height:8px!important}.syntaxhighlighter.ie .toolbar a{padding-top:0!important}.syntaxhighlighter.printing .line.alt1 .content,.syntaxhighlighter.printing .line.alt2 .content,.syntaxhighlighter.printing .line.highlighted .number,.syntaxhighlighter.printing .line.highlighted.alt1 .content,.syntaxhighlighter.printing .line.highlighted.alt2 .content{background:0 0!important}.syntaxhighlighter.printing .line .number{color:#bbb!important}.syntaxhighlighter.printing .line .content,.syntaxhighlighter.printing .plain,.syntaxhighlighter.printing .plain a{color:#000!important}.syntaxhighlighter.printing a{text-decoration:none!important}.syntaxhighlighter.printing .comments,.syntaxhighlighter.printing .comments a{color:#008200!important}.syntaxhighlighter.printing .string,.syntaxhighlighter.printing .string a{color:#00f!important}.syntaxhighlighter.printing .keyword{color:#069!important;font-weight:700!important}.syntaxhighlighter.printing .preprocessor{color:gray!important}.syntaxhighlighter.printing .variable{color:#a70!important}.syntaxhighlighter.printing .value{color:#090!important}.syntaxhighlighter.printing .functions{color:#ff1493!important}.syntaxhighlighter.printing .constants{color:#06c!important}.syntaxhighlighter.printing .color1,.syntaxhighlighter.printing .color1 a{color:gray!important}.syntaxhighlighter.printing .color2,.syntaxhighlighter.printing .color2 a{color:#ff1493!important}.syntaxhighlighter.printing .color3,.syntaxhighlighter.printing .color3 a{color:red!important}.syntaxhighlighter .line.highlighted.number,.syntaxhighlighter table caption,.syntaxhighlighter.printing .break,.syntaxhighlighter.printing .break a{color:#000!important}.syntaxhighlighter,.syntaxhighlighter .line.alt1,.syntaxhighlighter .line.alt2{background-color:#fff!important}.syntaxhighlighter .line.highlighted.alt1,.syntaxhighlighter .line.highlighted.alt2{background-color:#e0e0e0!important}.syntaxhighlighter .gutter{color:#afafaf!important}.syntaxhighlighter .gutter .line{border-right:3px solid #6ce26c!important}.syntaxhighlighter .gutter .line.highlighted{background-color:#6ce26c!important;color:#fff!important}.syntaxhighlighter.printing .line .content{border:none!important}.syntaxhighlighter.collapsed{overflow:visible!important}.syntaxhighlighter.collapsed .toolbar{color:#00f!important;background:#fff!important;border:1px solid #6ce26c!important}.syntaxhighlighter.collapsed .toolbar a{color:#00f!important}.syntaxhighlighter.collapsed .toolbar a:hover{color:red!important}.syntaxhighlighter .toolbar{color:#fff!important;background:#6ce26c!important;border:none!important}.syntaxhighlighter .toolbar a{color:#fff!important}.syntaxhighlighter .plain,.syntaxhighlighter .plain a,.syntaxhighlighter .toolbar a:hover{color:#000!important}.syntaxhighlighter .comments,.syntaxhighlighter .comments a{color:#008200!important}.syntaxhighlighter .string,.syntaxhighlighter .string a{color:#00f!important}.syntaxhighlighter .keyword{color:#069!important}.syntaxhighlighter .preprocessor{color:gray!important}.syntaxhighlighter .variable{color:#a70!important}.syntaxhighlighter .value{color:#090!important}.syntaxhighlighter .functions{color:#ff1493!important}.syntaxhighlighter .constants{color:#06c!important}.syntaxhighlighter .script{color:#069!important;background-color:none!important}.syntaxhighlighter .color1,.syntaxhighlighter .color1 a{color:gray!important}.syntaxhighlighter .color2,.syntaxhighlighter .color2 a{color:#ff1493!important}.syntaxhighlighter .color3,.syntaxhighlighter .color3 a{color:red!important}.syntaxhighlighter table{margin:1px 0!important}</style><title>java-basic-thread-dump-exart-show</title></head><body><h4 id="javabasicthreaddumpexart">java-basic-thread-dump-exart</h4>

<h4 id="javadump">啃碎并发（四）：Java 线程 Dump 分析</h4>

<h5 id="1threaddump">1 Thread Dump介绍</h5>

<h6 id="11threaddump">1.1 什么是 Thread Dump</h6>

<p>Thread Dump 是非常有用的诊断 Java 应用问题的工具。<strong>每一个 Java 虚拟机都有及时生成所有线程在某一点状态的 thread-dump 的能力</strong>，虽然各个 Java 虚拟机打印的 thread dump 略有不同，但是 <strong>大多都提供了当前活动线程的快照，及 JVM 中所有 Java 线程的堆栈跟踪信息，堆栈信息一般包含完整的类名及所执行的方法</strong>，如果可能的话还有源代码的行数。</p>

<h5 id="2threaddump">2 Thread Dump 分析</h5>

<h6 id="21threaddump">2.1 Thread Dump 信息</h6>

<p><strong>头部信息：时间，JVM 信息</strong></p>

<div><div class="syntaxhighlighter  java" id="highlighter_656318"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java value">2011</code><code class="java plain">-</code><code class="java value">11</code><code class="java plain">-</code><code class="java value">02</code> <code class="java value">19</code><code class="java plain">:</code><code class="java value">05</code><code class="java plain">:</code><code class="java value">06</code>&nbsp;</div><div class="line number2 index1 alt1"><code class="java plain">Full thread dump Java HotSpot(TM) Server VM (</code><code class="java value">16.3</code><code class="java plain">-b01 mixed mode): </code></div></div></td></tr></tbody></table></div></div>

<p><strong>线程 INFO 信息块</strong>：</p>

<div><div class="syntaxhighlighter  java" id="highlighter_894786"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java value">1</code><code class="java plain">. </code><code class="java string">"Timer-0"</code> <code class="java plain">daemon prio=</code><code class="java value">10</code> <code class="java plain">tid=</code><code class="java value">0xac190c00</code> <code class="java plain">nid=</code><code class="java value">0xaef</code> <code class="java plain">in Object.wait() [</code><code class="java value">0xae77d000</code><code class="java plain">] </code></div><div class="line number2 index1 alt1"><code class="java plain"># 线程名称：Timer-</code><code class="java value">0</code><code class="java plain">；线程类型：daemon；优先级: </code><code class="java value">10</code><code class="java plain">，默认是</code><code class="java value">5</code><code class="java plain">；</code></div><div class="line number3 index2 alt2"><code class="java plain"># JVM线程id：tid=</code><code class="java value">0xac190c00</code><code class="java plain">，JVM内部线程的唯一标识（通过java.lang.Thread.getId()获取，通常用自增方式实现）。</code></div><div class="line number4 index3 alt1"><code class="java plain"># 对应系统线程id（NativeThread ID）：nid=</code><code class="java value">0xaef</code><code class="java plain">，和top命令查看的线程pid对应，不过一个是</code><code class="java value">10</code><code class="java plain">进制，一个是</code><code class="java value">16</code><code class="java plain">进制。（通过命令：top -H -p pid，可以查看该进程的所有线程信息）</code></div><div class="line number5 index4 alt2"><code class="java plain"># 线程状态：in Object.wait()；</code></div><div class="line number6 index5 alt1"><code class="java plain"># 起始栈地址：[</code><code class="java value">0xae77d000</code><code class="java plain">]，对象的内存地址，通过JVM内存查看工具，能够看出线程是在哪儿个对象上等待；</code></div><div class="line number7 index6 alt2"><code class="java value">2</code><code class="java plain">.&nbsp; java.lang.Thread.State: TIMED_WAITING (on object monitor)</code></div><div class="line number8 index7 alt1"><code class="java value">3</code><code class="java plain">.&nbsp; at java.lang.Object.wait(Native Method)</code></div><div class="line number9 index8 alt2"><code class="java value">4</code><code class="java plain">.&nbsp; -waiting on &lt;</code><code class="java value">0xb3885f60</code><code class="java plain">&gt; (a java.util.TaskQueue)&nbsp;&nbsp;&nbsp;&nbsp; # 继续wait </code></div><div class="line number10 index9 alt1"><code class="java value">5</code><code class="java plain">.&nbsp; at java.util.TimerThread.mainLoop(Timer.java:</code><code class="java value">509</code><code class="java plain">)</code></div><div class="line number11 index10 alt2"><code class="java value">6</code><code class="java plain">.&nbsp; -locked &lt;</code><code class="java value">0xb3885f60</code><code class="java plain">&gt; (a java.util.TaskQueue)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # 已经locked</code></div><div class="line number12 index11 alt1"><code class="java value">7</code><code class="java plain">.&nbsp; at java.util.TimerThread.run(Timer.java:</code><code class="java value">462</code><code class="java plain">)</code></div></div></td></tr></tbody></table></div></div>

<p><strong>Java thread statck trace：是上面 2-7 行的信息</strong>。到目前为止这是最重要的数据，Java stack trace 提供了大部分信息来精确定位问题根源。</p>

<p>Java thread statck trace 详解：</p>

<p><strong>堆栈信息应该逆向解读</strong>：程序先执行的是第 7 行，然后是第 6 行，依次类推。</p>

<div><div class="syntaxhighlighter  java" id="highlighter_27630"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java plain">- locked &lt;</code><code class="java value">0xb3885f60</code><code class="java plain">&gt; (a java.util.ArrayList)</code></div><div class="line number2 index1 alt1"><code class="java plain">- waiting on &lt;</code><code class="java value">0xb3885f60</code><code class="java plain">&gt; (a java.util.ArrayList) </code></div></div></td></tr></tbody></table></div></div>

<p><strong>也就是说对象先上锁，锁住对象 0xb3885f60，然后释放该对象锁，进入 waiting 状态</strong>。为啥会出现这样的情况呢？看看下面的 Java 代码示例，就会明白：</p>

<div><div class="syntaxhighlighter  java" id="highlighter_301992"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">synchronized</code><code class="java plain">(obj) {&nbsp; </code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;</code><code class="java plain">.........&nbsp; </code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;</code><code class="java plain">obj.wait();&nbsp; </code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;</code><code class="java plain">.........&nbsp; </code></div><div class="line number5 index4 alt2"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>

<p>如上，线程的执行过程，<strong>先用 synchronized 获得了这个对象的 Monitor（对应于 locked <code>&lt;0xb3885f60&gt;</code> ）。当执行到 obj.wait()，线程即放弃了 Monitor的所有权，进入 “wait set”队列（对应于 waiting on <code>&lt;0xb3885f60&gt;</code> ）。</strong></p>

<p><strong>在堆栈的第一行信息中，进一步标明了线程在代码级的状态</strong>，例如：</p>

<div><div class="syntaxhighlighter  java" id="highlighter_123214"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java plain">java.lang.Thread.State: TIMED_WAITING (parking)</code></div></div></td></tr></tbody></table></div></div>

<p>解释如下：</p>

<div><div class="syntaxhighlighter  java" id="highlighter_107037"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java plain">|blocked|</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="java plain">&gt; This thread tried to enter asynchronized block, but the lock was taken by another thread. This thread isblocked until the lock gets released.</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="java plain">|blocked (on thin lock)|</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="java plain">&gt; This is the same state asblocked, but the lock in question is a thin lock.</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="java plain">|waiting|</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="java plain">&gt; This thread calledObject.wait() on an object. The thread will remain there until some otherthread sends a notification to that object.</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="java plain">|sleeping|</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="java plain">&gt; This thread calledjava.lang.Thread.sleep().</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="java plain">|parked|</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="java plain">&gt; This thread calledjava.util.concurrent.locks.LockSupport.park().</code></div><div class="line number20 index19 alt1">&nbsp;</div><div class="line number21 index20 alt2"><code class="java plain">|suspended|</code></div><div class="line number22 index21 alt1">&nbsp;</div><div class="line number23 index22 alt2"><code class="java plain">&gt; The thread's execution wassuspended by java.lang.Thread.suspend() or a JVMTI agent call.</code></div></div></td></tr></tbody></table></div></div>

<h6 id="22thread">2.2 Thread 状态分析</h6>

<p>线程的状态是一个很重要的东西，因此 thread dump 中会显示这些状态，通过对这些状态的分析，能够得出线程的运行状况，进而发现可能存在的问题。线程的状态在 Thread.State 这个枚举类型中定义：</p>

<div><div class="syntaxhighlighter  java" id="highlighter_549402"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">public</code> <code class="java keyword">enum</code> <code class="java plain">State</code></div><div class="line number2 index1 alt1"><code class="java plain">{</code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Thread state for a thread which has not yet started.</code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">NEW,</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Thread state for a runnable thread.&nbsp; A thread in the runnable</code></div><div class="line number10 index9 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* state is executing in the Java virtual machine but it may</code></div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* be waiting for other resources from the operating system</code></div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* such as processor.</code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">RUNNABLE,</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number17 index16 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Thread state for a thread blocked waiting for a monitor lock.</code></div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* A thread in the blocked state is waiting for a monitor lock</code></div><div class="line number19 index18 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* to enter a synchronized block/method or</code></div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* reenter a synchronized block/method after calling</code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* {@link Object#wait() Object.wait}.</code></div><div class="line number22 index21 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number23 index22 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">BLOCKED,</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number26 index25 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Thread state for a waiting thread.</code></div><div class="line number27 index26 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* A thread is in the waiting state due to calling one of the</code></div><div class="line number28 index27 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* following methods:</code></div><div class="line number29 index28 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;ul&gt;</code></div><div class="line number30 index29 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp; &lt;li&gt;{@link Object#wait() Object.wait} with no timeout&lt;/li&gt;</code></div><div class="line number31 index30 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp; &lt;li&gt;{@link #join() Thread.join} with no timeout&lt;/li&gt;</code></div><div class="line number32 index31 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp; &lt;li&gt;{@link LockSupport#park() LockSupport.park}&lt;/li&gt;</code></div><div class="line number33 index32 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;/ul&gt;</code></div><div class="line number34 index33 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number35 index34 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;p&gt;A thread in the waiting state is waiting for another thread to</code></div><div class="line number36 index35 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* perform a particular action.</code></div><div class="line number37 index36 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*</code></div><div class="line number38 index37 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* For example, a thread that has called &lt;tt&gt;Object.wait()&lt;/tt&gt;</code></div><div class="line number39 index38 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* on an object is waiting for another thread to call</code></div><div class="line number40 index39 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;tt&gt;Object.notify()&lt;/tt&gt; or &lt;tt&gt;Object.notifyAll()&lt;/tt&gt; on</code></div><div class="line number41 index40 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* that object. A thread that has called &lt;tt&gt;Thread.join()&lt;/tt&gt;</code></div><div class="line number42 index41 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* is waiting for a specified thread to terminate.</code></div><div class="line number43 index42 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number44 index43 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">WAITING,</code></div><div class="line number45 index44 alt2">&nbsp;</div><div class="line number46 index45 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number47 index46 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Thread state for a waiting thread with a specified waiting time.</code></div><div class="line number48 index47 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* A thread is in the timed waiting state due to calling one of</code></div><div class="line number49 index48 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* the following methods with a specified positive waiting time:</code></div><div class="line number50 index49 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;ul&gt;</code></div><div class="line number51 index50 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp; &lt;li&gt;{@link #sleep Thread.sleep}&lt;/li&gt;</code></div><div class="line number52 index51 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp; &lt;li&gt;{@link Object#wait(long) Object.wait} with timeout&lt;/li&gt;</code></div><div class="line number53 index52 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp; &lt;li&gt;{@link #join(long) Thread.join} with timeout&lt;/li&gt;</code></div><div class="line number54 index53 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp; &lt;li&gt;{@link LockSupport#parkNanos LockSupport.parkNanos}&lt;/li&gt;</code></div><div class="line number55 index54 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*&nbsp;&nbsp; &lt;li&gt;{@link LockSupport#parkUntil LockSupport.parkUntil}&lt;/li&gt;</code></div><div class="line number56 index55 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* &lt;/ul&gt;</code></div><div class="line number57 index56 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number58 index57 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">TIMED_WAITING,</code></div><div class="line number59 index58 alt2">&nbsp;</div><div class="line number60 index59 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">/**</code></div><div class="line number61 index60 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* Thread state for a terminated thread.</code></div><div class="line number62 index61 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">* The thread has completed execution.</code></div><div class="line number63 index62 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java preprocessor">*/</code></div><div class="line number64 index63 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">TERMINATED;</code></div><div class="line number65 index64 alt2"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>

<ul>
<li><p><strong>NEW</strong>：</p>

<p>每一个线程，在堆内存中都有一个对应的Thread对象。Thread t = new Thread(); 当刚刚在堆内存中创建 Thread 对象，还没有调用 t.start() 方法之前，线程就处在 NEW 状态。在这个状态上，线程与普通的 Java 对象没有什么区别，就仅仅是一个堆内存中的对象。</p></li>
<li><p><strong>RUNNABLE</strong>：</p>

<p>该状态表示线程具备所有运行条件，在运行队列中准备操作系统的调度，或者正在运行。 这个状态的线程比较正常，但如果线程长时间停留在在这个状态就不正常了，这说明线程运行的时间很长（存在性能问题），或者是线程一直得不得执行的机会（存在线程饥饿的问题）。</p></li>
<li><p><strong>BLOCKED</strong>：</p>

<p>线程正在等待获取 Java 对象的监视器(也叫内置锁)，即线程正在等待进入由 synchronized 保护的方法或者代码块。synchronized 用来保证原子性，任意时刻最多只能由一个线程进入该临界区域，其他线程只能排队等待。</p></li>
<li><p><strong>WAITING</strong>：</p>

<p>处在该线程的状态，正在等待某个事件的发生，只有特定的条件满足，才能获得执行机会。而产生这个特定的事件，通常都是另一个线程。也就是说，如果不发生特定的事件，那么处在该状态的线程一直等待，不能获取执行的机会。比如：</p>

<p>A 线程调用了 obj 对象的 obj.wait() 方法，如果没有线程调用 obj.notify 或 obj.notifyAll，那么A线程就没有办法恢复运行；</p>

<p>如果 A 线程调用了 LockSupport.park()，没有别的线程调用 LockSupport.unpark(A)，那么A没有办法恢复运行。</p></li>
<li><p><strong>TIMED_WAITING</strong>：</p>

<p>J.U.C 中很多与线程相关类，都提供了限时版本和不限时版本的 API。TIMED<em>WAITING 意味着线程调用了限时版本的 API，正在等待时间流逝。当等待时间过去后，线程一样可以恢复运行。如果线程进入了 WAITING 状态，一定要特定的事件发生才能恢复运行；而处在 TIMED</em>WAITING 的线程，如果特定的事件发生或者是时间流逝完毕，都会恢复运行。</p></li>
<li><p><strong>TERMINATED</strong>：</p>

<p>线程执行完毕，执行完 run 方法正常返回，或者抛出了运行时异常而结束，线程都会停留在这个状态。这个时候线程只剩下 Thread 对象了，没有什么用了。</p></li>
</ul>

<h6 id="23">2.3 关键状态分析</h6>

<ul>
<li><p><strong>Wait on condition</strong>：The thread is either sleeping or waiting to be notified by another thread.</p>

<p>该状态说明它在等待另一个条件的发生，来把自己唤醒，或者干脆它是调用了 sleep(n)。</p>

<p>此时线程状态大致为以下几种：</p>

<ul><li><p>java.lang.Thread.State: WAITING (parking)：</p>

<p>一直等那个条件发生；</p></li>
<li><p>java.lang.Thread.State: TIMED_WAITING (parking或sleeping)：</p>

<p>定时的，那个条件不到来，也将定时唤醒自己。</p></li></ul></li>
<li><p><strong>Waiting for Monitor Entry 和 in Object.wait()</strong>：The thread is waiting to get the lock for an object (some other thread may be holding the lock). This happens if two or more threads try to execute synchronized code. Note that the lock is always for an object and not for individual methods.</p>

<p>在多线程的 JAVA 程序中，实现线程之间的同步，就要说说 Monitor。 Monitor 是 Java 中用以实现线程之间的互斥与协作的主要手段，它可以看成是对象或者 Class 的锁。每一个对象都有，也仅有一个 Monitor。下面这个图，描述了线程和 Monitor 之间关系，以及线程的状态转换图：</p></li>
</ul>

<p><img title="" alt="title" src="images/java-basic-thread-dump-exart/java-basic-thread-dump-exart-001.png"></p>

<p>如上图，每个 Monitor 在某个时刻，只能被一个线程拥有，该线程就是 “ActiveThread”，而其它线程都是 “Waiting Thread”，分别在两个队列 “Entry Set” 和 “Wait Set” 里等候。在 “Entry Set” 中等待的线程状态是 “Waiting for monitor entry”，而在 “Wait Set” 中等待的线程状态是 “in Object.wait()”。</p>

<p>先看 “Entry Set” 里面的线程。我们称被 synchronized 保护起来的代码段为临界区。当一个线程申请进入临界区时，它就进入了 “Entry Set” 队列。对应的 code 就像：</p>

<div><div class="syntaxhighlighter  java" id="highlighter_290531"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">synchronized</code><code class="java plain">(obj) {</code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;</code><code class="java plain">.........</code></div><div class="line number3 index2 alt2"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>

<p>这时有两种可能性：</p>

<ul>
<li><p>该 monitor 不被其它线程拥有， Entry Set 里面也没有其它等待线程。本线程即成为相应类或者对象的 Monitor 的 Owner，执行临界区的代码。</p></li>
<li><p>该 monitor 被其它线程拥有，本线程在 Entry Set 队列中等待。</p></li>
</ul>

<p><strong>在第一种情况下，线程将处于 “Runnable”的状态，而第二种情况下，线程 DUMP会显示处于 “waiting for monitor entry”</strong>。如下：</p>

<div><div class="syntaxhighlighter  java" id="highlighter_181096"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java string">"Thread-0"</code> <code class="java plain">prio=</code><code class="java value">10</code> <code class="java plain">tid=</code><code class="java value">0x08222eb0</code> <code class="java plain">nid=</code><code class="java value">0x9</code> <code class="java plain">waiting </code><code class="java keyword">for</code> <code class="java plain">monitor entry [</code><code class="java value">0xf927b000</code><code class="java plain">..</code><code class="java value">0xf927bdb8</code><code class="java plain">] </code></div><div class="line number2 index1 alt1"><code class="java plain">at testthread.WaitThread.run(WaitThread.java:</code><code class="java value">39</code><code class="java plain">) </code></div><div class="line number3 index2 alt2"><code class="java plain">- waiting to lock &lt;</code><code class="java value">0xef63bf08</code><code class="java plain">&gt; (a java.lang.Object) </code></div><div class="line number4 index3 alt1"><code class="java plain">- locked &lt;</code><code class="java value">0xef63beb8</code><code class="java plain">&gt; (a java.util.ArrayList) </code></div><div class="line number5 index4 alt2"><code class="java plain">at java.lang.Thread.run(Thread.java:</code><code class="java value">595</code><code class="java plain">) </code></div></div></td></tr></tbody></table></div></div>

<p><strong>临界区的设置，是为了保证其内部的代码执行的原子性和完整性</strong>。但是因为临界区在任何时间只允许线程串行通过，这和我们多线程的程序的初衷是相反的。<strong>如果在多线程的程序中，大量使用 synchronized，或者不适当的使用了它，会造成大量线程在临界区的入口等待，造成系统的性能大幅下降</strong>。如果在线程 DUMP 中发现了这个情况，应该审查源码，改进程序。</p>

<p>再看 <strong>“Wait Set” 里面的线程</strong>。当线程获得了 Monitor，进入了临界区之后，<strong>如果发现线程继续运行的条件没有满足，它则调用对象（一般就是被 synchronized 的对象）的 wait() 方法，放弃 Monitor，进入 “Wait Set” 队列。只有当别的线程在该对象上调用了 notify() 或者 notifyAll()，“Wait Set”队列中线程才得到机会去竞争</strong>，但是只有一个线程获得对象的 Monitor，恢复到运行态。<strong>在 “Wait Set” 中的线程， DUMP 中表现为： in Object.wait()</strong>。如下：</p>

<div><div class="syntaxhighlighter  java" id="highlighter_301985"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java string">"Thread-1"</code> <code class="java plain">prio=</code><code class="java value">10</code> <code class="java plain">tid=</code><code class="java value">0x08223250</code> <code class="java plain">nid=</code><code class="java value">0xa</code> <code class="java plain">in Object.wait() [</code><code class="java value">0xef47a000</code><code class="java plain">..</code><code class="java value">0xef47aa38</code><code class="java plain">] </code></div><div class="line number2 index1 alt1"><code class="java spaces">&nbsp;</code><code class="java plain">at java.lang.Object.wait(Native Method) </code></div><div class="line number3 index2 alt2"><code class="java spaces">&nbsp;</code><code class="java plain">- waiting on &lt;</code><code class="java value">0xef63beb8</code><code class="java plain">&gt; (a java.util.ArrayList) </code></div><div class="line number4 index3 alt1"><code class="java spaces">&nbsp;</code><code class="java plain">at java.lang.Object.wait(Object.java:</code><code class="java value">474</code><code class="java plain">) </code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;</code><code class="java plain">at testthread.MyWaitThread.run(MyWaitThread.java:</code><code class="java value">40</code><code class="java plain">) </code></div><div class="line number6 index5 alt1"><code class="java spaces">&nbsp;</code><code class="java plain">- locked &lt;</code><code class="java value">0xef63beb8</code><code class="java plain">&gt; (a java.util.ArrayList) </code></div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;</code><code class="java plain">at java.lang.Thread.run(Thread.java:</code><code class="java value">595</code><code class="java plain">) </code></div></div></td></tr></tbody></table></div></div>

<p>综上，一般 CPU 很忙时，则关注 runnable 的线程，CPU 很闲时，则关注 waiting for monitor entry 的线程。</p>

<ul>
<li><strong>JDK 5.0 的 Lock</strong></li>
</ul>

<p>上面提到如果 synchronized 和 monitor 机制运用不当，可能会造成多线程程序的性能问题。在 JDK 5.0 中，引入了 Lock 机制，从而使开发者能更灵活的开发高性能的并发多线程程序，可以替代以往 JDK 中的 synchronized 和 Monitor 的 机制。<strong>但是，要注意的是，因为 Lock 类只是一个普通类，JVM 无从得知 Lock 对象的占用情况，所以在线程 DUMP 中，也不会包含关于 Lock 的信息</strong>， 关于死锁等问题，就不如用 synchronized 的编程方式容易识别。</p>

<h5 id="24">2.4 关键状态示例</h5>

<ul>
<li><strong>显示 BLOCKED 状态</strong></li>
</ul>

<div><div class="syntaxhighlighter  java" id="highlighter_116"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">package</code> <code class="java plain">jstack;</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="java keyword">public</code> <code class="java keyword">class</code> <code class="java plain">BlockedState</code></div><div class="line number4 index3 alt1"><code class="java plain">{</code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java plain">Object object = </code><code class="java keyword">new</code> <code class="java plain">Object();</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">static</code> <code class="java keyword">void</code> <code class="java plain">main(String[] args)</code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Runnable task = </code><code class="java keyword">new</code> <code class="java plain">Runnable() {</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@Override</code></div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">run()</code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">synchronized</code> <code class="java plain">(object)</code></div><div class="line number15 index14 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">begin = System.currentTimeMillis();</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">end = System.currentTimeMillis();</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// 让线程运行5分钟,会一直持有object的监视器</code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">((end - begin) &lt;= </code><code class="java value">5</code> <code class="java plain">* </code><code class="java value">60</code> <code class="java plain">* </code><code class="java value">1000</code><code class="java plain">)</code></div><div class="line number22 index21 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number23 index22 alt2">&nbsp;</div><div class="line number24 index23 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number25 index24 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number26 index25 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number27 index26 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">};</code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">new</code> <code class="java plain">Thread(task, </code><code class="java string">"t1"</code><code class="java plain">).start();</code></div><div class="line number30 index29 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">new</code> <code class="java plain">Thread(task, </code><code class="java string">"t2"</code><code class="java plain">).start();</code></div><div class="line number31 index30 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number32 index31 alt1"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>

<p>先获取 object 的线程会执行 5 分钟，这 5 分钟内会一直持有 object 的监视器，另一个线程无法执行处在 BLOCKED 状态：</p>

<div><div class="syntaxhighlighter  java" id="highlighter_990457"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java plain">Full thread dump Java HotSpot(TM) Server VM (</code><code class="java value">20.12</code><code class="java plain">-b01 mixed mode):&nbsp; </code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="java string">"DestroyJavaVM"</code> <code class="java plain">prio=</code><code class="java value">6</code> <code class="java plain">tid=</code><code class="java value">0x00856c00</code> <code class="java plain">nid=</code><code class="java value">0x1314</code> <code class="java plain">waiting on condition [</code><code class="java value">0x00000000</code><code class="java plain">]&nbsp; </code></div><div class="line number4 index3 alt1"><code class="java plain">java.lang.Thread.State: RUNNABLE&nbsp; </code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="java string">"t2"</code> <code class="java plain">prio=</code><code class="java value">6</code> <code class="java plain">tid=</code><code class="java value">0x27d7a800</code> <code class="java plain">nid=</code><code class="java value">0x1350</code> <code class="java plain">waiting </code><code class="java keyword">for</code> <code class="java plain">monitor entry [</code><code class="java value">0x2833f000</code><code class="java plain">]&nbsp; </code></div><div class="line number7 index6 alt2"><code class="java plain">java.lang.Thread.State: BLOCKED (on object monitor)&nbsp; </code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at jstack.BlockedState$</code><code class="java value">1</code><code class="java plain">.run(BlockedState.java:</code><code class="java value">17</code><code class="java plain">)&nbsp; </code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">- waiting to lock &lt;</code><code class="java value">0x1cfcdc00</code><code class="java plain">&gt; (a java.lang.Object)&nbsp; </code></div><div class="line number10 index9 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.lang.Thread.run(Thread.java:</code><code class="java value">662</code><code class="java plain">)&nbsp; </code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="java string">"t1"</code> <code class="java plain">prio=</code><code class="java value">6</code> <code class="java plain">tid=</code><code class="java value">0x27d79400</code> <code class="java plain">nid=</code><code class="java value">0x1338</code> <code class="java plain">runnable [</code><code class="java value">0x282ef000</code><code class="java plain">]&nbsp; </code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;</code><code class="java plain">java.lang.Thread.State: RUNNABLE&nbsp; </code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at jstack.BlockedState$</code><code class="java value">1</code><code class="java plain">.run(BlockedState.java:</code><code class="java value">22</code><code class="java plain">)&nbsp; </code></div><div class="line number15 index14 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">- locked &lt;</code><code class="java value">0x1cfcdc00</code><code class="java plain">&gt; (a java.lang.Object)&nbsp; </code></div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.lang.Thread.run(Thread.java:</code><code class="java value">662</code><code class="java plain">)</code></div></div></td></tr></tbody></table></div></div>

<p>通过 thread dump 可以看到：t2 线程确实处在 BLOCKED (on object monitor)。waiting for monitor entry 等待进入 synchronized 保护的区域。</p>

<ul>
<li><strong>显示 WAITING 状态</strong></li>
</ul>

<div><div class="syntaxhighlighter  java" id="highlighter_368314"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">package</code> <code class="java plain">jstack;</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="java keyword">public</code> <code class="java keyword">class</code> <code class="java plain">WaitingState</code></div><div class="line number4 index3 alt1"><code class="java plain">{</code></div><div class="line number5 index4 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java plain">Object object = </code><code class="java keyword">new</code> <code class="java plain">Object();</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">static</code> <code class="java keyword">void</code> <code class="java plain">main(String[] args)</code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Runnable task = </code><code class="java keyword">new</code> <code class="java plain">Runnable() {</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@Override</code></div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">run()</code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">synchronized</code> <code class="java plain">(object)</code></div><div class="line number15 index14 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">begin = System.currentTimeMillis();</code></div><div class="line number17 index16 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">long</code> <code class="java plain">end = System.currentTimeMillis();</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// 让线程运行5分钟,会一直持有object的监视器</code></div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">while</code> <code class="java plain">((end - begin) &lt;= </code><code class="java value">5</code> <code class="java plain">* </code><code class="java value">60</code> <code class="java plain">* </code><code class="java value">1000</code><code class="java plain">)</code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number22 index21 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code></div><div class="line number23 index22 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number24 index23 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// 进入等待的同时,会进入释放监视器</code></div><div class="line number25 index24 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">object.wait();</code></div><div class="line number26 index25 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">catch</code> <code class="java plain">(InterruptedException e)</code></div><div class="line number27 index26 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number28 index27 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">e.printStackTrace();</code></div><div class="line number29 index28 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number30 index29 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number31 index30 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number32 index31 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number33 index32 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">};</code></div><div class="line number34 index33 alt1">&nbsp;</div><div class="line number35 index34 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">new</code> <code class="java plain">Thread(task, </code><code class="java string">"t1"</code><code class="java plain">).start();</code></div><div class="line number36 index35 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">new</code> <code class="java plain">Thread(task, </code><code class="java string">"t2"</code><code class="java plain">).start();</code></div><div class="line number37 index36 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number38 index37 alt1"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>

<div><div class="syntaxhighlighter  java" id="highlighter_276085"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java plain">Full thread dump Java HotSpot(TM) Server VM (</code><code class="java value">20.12</code><code class="java plain">-b01 mixed mode):&nbsp; </code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="java string">"DestroyJavaVM"</code> <code class="java plain">prio=</code><code class="java value">6</code> <code class="java plain">tid=</code><code class="java value">0x00856c00</code> <code class="java plain">nid=</code><code class="java value">0x1734</code> <code class="java plain">waiting on condition [</code><code class="java value">0x00000000</code><code class="java plain">]&nbsp; </code></div><div class="line number4 index3 alt1"><code class="java plain">java.lang.Thread.State: RUNNABLE&nbsp; </code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="java string">"t2"</code> <code class="java plain">prio=</code><code class="java value">6</code> <code class="java plain">tid=</code><code class="java value">0x27d7e000</code> <code class="java plain">nid=</code><code class="java value">0x17f4</code> <code class="java plain">in Object.wait() [</code><code class="java value">0x2833f000</code><code class="java plain">]&nbsp; </code></div><div class="line number7 index6 alt2"><code class="java plain">java.lang.Thread.State: WAITING (on object monitor)&nbsp; </code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.lang.Object.wait(Native Method)&nbsp; </code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">- waiting on &lt;</code><code class="java value">0x1cfcdc00</code><code class="java plain">&gt; (a java.lang.Object)&nbsp; </code></div><div class="line number10 index9 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.lang.Object.wait(Object.java:</code><code class="java value">485</code><code class="java plain">)&nbsp; </code></div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at jstack.WaitingState$</code><code class="java value">1</code><code class="java plain">.run(WaitingState.java:</code><code class="java value">26</code><code class="java plain">)&nbsp; </code></div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">- locked &lt;</code><code class="java value">0x1cfcdc00</code><code class="java plain">&gt; (a java.lang.Object)&nbsp; </code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.lang.Thread.run(Thread.java:</code><code class="java value">662</code><code class="java plain">)&nbsp; </code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="java string">"t1"</code> <code class="java plain">prio=</code><code class="java value">6</code> <code class="java plain">tid=</code><code class="java value">0x27d7d400</code> <code class="java plain">nid=</code><code class="java value">0x17f0</code> <code class="java plain">in Object.wait() [</code><code class="java value">0x282ef000</code><code class="java plain">]&nbsp; </code></div><div class="line number16 index15 alt1"><code class="java plain">java.lang.Thread.State: WAITING (on object monitor)&nbsp; </code></div><div class="line number17 index16 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.lang.Object.wait(Native Method)&nbsp; </code></div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">- waiting on &lt;</code><code class="java value">0x1cfcdc00</code><code class="java plain">&gt; (a java.lang.Object)&nbsp; </code></div><div class="line number19 index18 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.lang.Object.wait(Object.java:</code><code class="java value">485</code><code class="java plain">)&nbsp; </code></div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at jstack.WaitingState$</code><code class="java value">1</code><code class="java plain">.run(WaitingState.java:</code><code class="java value">26</code><code class="java plain">)&nbsp; </code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">- locked &lt;</code><code class="java value">0x1cfcdc00</code><code class="java plain">&gt; (a java.lang.Object)&nbsp; </code></div><div class="line number22 index21 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.lang.Thread.run(Thread.java:</code><code class="java value">662</code><code class="java plain">)&nbsp; </code></div></div></td></tr></tbody></table></div></div>

<p>可以发现 t1 和 t2 都处在 WAITING (on object monitor)，<strong>进入等待状态的原因是调用了 in Object.wait()。通过 J.U.C 包下的锁和条件队列，也是这个效果</strong>，大家可以自己实践下。</p>

<ul>
<li><strong>显示 TIMED_WAITING 状态</strong></li>
</ul>

<div><div class="syntaxhighlighter  java" id="highlighter_579865"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java keyword">package</code> <code class="java plain">jstack;</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="java keyword">import</code> <code class="java plain">java.util.concurrent.TimeUnit;</code></div><div class="line number4 index3 alt1"><code class="java keyword">import</code> <code class="java plain">java.util.concurrent.locks.Condition;</code></div><div class="line number5 index4 alt2"><code class="java keyword">import</code> <code class="java plain">java.util.concurrent.locks.Lock;</code></div><div class="line number6 index5 alt1"><code class="java keyword">import</code> <code class="java plain">java.util.concurrent.locks.ReentrantLock;</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="java keyword">public</code> <code class="java keyword">class</code> <code class="java plain">TimedWaitingState</code></div><div class="line number9 index8 alt2"><code class="java plain">{</code></div><div class="line number10 index9 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// java的显示锁,类似java对象内置的监视器</code></div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java plain">Lock lock = </code><code class="java keyword">new</code> <code class="java plain">ReentrantLock();</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// 锁关联的条件队列(类似于object.wait)</code></div><div class="line number14 index13 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">private</code> <code class="java keyword">static</code> <code class="java plain">Condition condition = lock.newCondition();</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">static</code> <code class="java keyword">void</code> <code class="java plain">main(String[] args)</code></div><div class="line number17 index16 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">Runnable task = </code><code class="java keyword">new</code> <code class="java plain">Runnable() {</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java color1">@Override</code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">public</code> <code class="java keyword">void</code> <code class="java plain">run()</code></div><div class="line number22 index21 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number23 index22 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// 加锁,进入临界区</code></div><div class="line number24 index23 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">lock.lock();</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">try</code></div><div class="line number27 index26 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number28 index27 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">condition.await(</code><code class="java value">5</code><code class="java plain">, TimeUnit.MINUTES);</code></div><div class="line number29 index28 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">} </code><code class="java keyword">catch</code> <code class="java plain">(InterruptedException e)</code></div><div class="line number30 index29 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">{</code></div><div class="line number31 index30 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">e.printStackTrace();</code></div><div class="line number32 index31 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number33 index32 alt2">&nbsp;</div><div class="line number34 index33 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java comments">// 解锁,退出临界区</code></div><div class="line number35 index34 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">lock.unlock();</code></div><div class="line number36 index35 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number37 index36 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">};</code></div><div class="line number38 index37 alt1">&nbsp;</div><div class="line number39 index38 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">new</code> <code class="java plain">Thread(task, </code><code class="java string">"t1"</code><code class="java plain">).start();</code></div><div class="line number40 index39 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java keyword">new</code> <code class="java plain">Thread(task, </code><code class="java string">"t2"</code><code class="java plain">).start();</code></div><div class="line number41 index40 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">}</code></div><div class="line number42 index41 alt1"><code class="java plain">}</code></div></div></td></tr></tbody></table></div></div>

<div><div class="syntaxhighlighter  java" id="highlighter_415624"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java plain">Full thread dump Java HotSpot(TM) Server VM (</code><code class="java value">20.12</code><code class="java plain">-b01 mixed mode):&nbsp; </code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="java string">"DestroyJavaVM"</code> <code class="java plain">prio=</code><code class="java value">6</code> <code class="java plain">tid=</code><code class="java value">0x00856c00</code> <code class="java plain">nid=</code><code class="java value">0x169c</code> <code class="java plain">waiting on condition [</code><code class="java value">0x00000000</code><code class="java plain">]&nbsp; </code></div><div class="line number4 index3 alt1"><code class="java plain">java.lang.Thread.State: RUNNABLE&nbsp; </code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="java string">"t2"</code> <code class="java plain">prio=</code><code class="java value">6</code> <code class="java plain">tid=</code><code class="java value">0x27d7d800</code> <code class="java plain">nid=</code><code class="java value">0xc30</code> <code class="java plain">waiting on condition [</code><code class="java value">0x2833f000</code><code class="java plain">]&nbsp; </code></div><div class="line number7 index6 alt2"><code class="java plain">java.lang.Thread.State: TIMED_WAITING (parking)&nbsp; </code></div><div class="line number8 index7 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at sun.misc.Unsafe.park(Native Method)&nbsp; </code></div><div class="line number9 index8 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">- parking to wait </code><code class="java keyword">for</code>&nbsp; <code class="java plain">&lt;</code><code class="java value">0x1cfce5b8</code><code class="java plain">&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)&nbsp; </code></div><div class="line number10 index9 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:</code><code class="java value">196</code><code class="java plain">)&nbsp; </code></div><div class="line number11 index10 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:</code><code class="java value">2116</code><code class="java plain">)&nbsp; </code></div><div class="line number12 index11 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at jstack.TimedWaitingState$</code><code class="java value">1</code><code class="java plain">.run(TimedWaitingState.java:</code><code class="java value">28</code><code class="java plain">)&nbsp; </code></div><div class="line number13 index12 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.lang.Thread.run(Thread.java:</code><code class="java value">662</code><code class="java plain">)&nbsp; </code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="java string">"t1"</code> <code class="java plain">prio=</code><code class="java value">6</code> <code class="java plain">tid=</code><code class="java value">0x280d0c00</code> <code class="java plain">nid=</code><code class="java value">0x16e0</code> <code class="java plain">waiting on condition [</code><code class="java value">0x282ef000</code><code class="java plain">]&nbsp; </code></div><div class="line number16 index15 alt1"><code class="java plain">java.lang.Thread.State: TIMED_WAITING (parking)&nbsp; </code></div><div class="line number17 index16 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at sun.misc.Unsafe.park(Native Method)&nbsp; </code></div><div class="line number18 index17 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">- parking to wait </code><code class="java keyword">for</code>&nbsp; <code class="java plain">&lt;</code><code class="java value">0x1cfce5b8</code><code class="java plain">&gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)&nbsp; </code></div><div class="line number19 index18 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:</code><code class="java value">196</code><code class="java plain">)&nbsp; </code></div><div class="line number20 index19 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:</code><code class="java value">2116</code><code class="java plain">)&nbsp; </code></div><div class="line number21 index20 alt2"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at jstack.TimedWaitingState$</code><code class="java value">1</code><code class="java plain">.run(TimedWaitingState.java:</code><code class="java value">28</code><code class="java plain">)&nbsp; </code></div><div class="line number22 index21 alt1"><code class="java spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="java plain">at java.lang.Thread.run(Thread.java:</code><code class="java value">662</code><code class="java plain">)&nbsp; </code></div></div></td></tr></tbody></table></div></div>

<p>可以看到 t1 和 t2 线程都处在 java.lang.Thread.State: TIMED_WAITING (parking)，这个 parking 代表是调用的 JUC 下的工具类，而不是 Java 默认的监视器。</p>

<h5 id="3">3 案例分析</h5>

<h6 id="31">3.1 问题场景</h6>

<ul>
<li><p><strong>CPU 飙高，load 高，响应很慢</strong></p>

<ul><li><p>一个请求过程中多次 dump；</p></li>
<li><p>对比多次 dump 文件的 runnable 线程，如果执行的方法有比较大变化，说明比较正常。如果在执行同一个方法，就有一些问题了；</p></li></ul></li>
<li><p><strong>查找占用 CPU 最多的线程</strong></p>

<ul><li><p>使用命令：<strong>top -H -p pid</strong>（pid 为被测系统的进程号），找到导致 CPU 高的线程 ID，对应 thread dump 信息中线程的nid，只不过一个是十进制，一个是十六进制；</p></li>
<li><p>在thread dump中，根据top命令查找的线程id，查找对应的线程堆栈信息；</p></li></ul></li>
<li><p><strong>CPU 使用率不高但是响应很慢</strong></p>

<p>进行 dump，查看是否有很多 thread struck 在了 i/o、数据库等地方，定位瓶颈原因；</p></li>
<li><p><strong>请求无法响应</strong></p>

<ul><li>多次 dump，对比是否所有的 runnable 线程都一直在执行相同的方法，如果是的，恭喜你，锁住了！</li></ul></li>
</ul>

<h6 id="32">3.2 死锁</h6>

<p>死锁经常表现为程序的停顿，或者不再响应用户的请求。从操作系统上观察，对应进程的 CPU 占用率为零，很快会从 top 或 prstat 的输出中消失。</p>

<p><strong>比如在下面这个示例中，是个较为典型的死锁情况：</strong></p>

<div><div class="syntaxhighlighter  java" id="highlighter_790813"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java string">"Thread-1"</code> <code class="java plain">prio=</code><code class="java value">5</code> <code class="java plain">tid=</code><code class="java value">0x00acc490</code> <code class="java plain">nid=</code><code class="java value">0xe50</code> <code class="java plain">waiting </code><code class="java keyword">for</code> <code class="java plain">monitor entry [</code><code class="java value">0x02d3f000</code></div><div class="line number2 index1 alt1"><code class="java plain">..</code><code class="java value">0x02d3fd68</code><code class="java plain">] </code></div><div class="line number3 index2 alt2"><code class="java plain">at deadlockthreads.TestThread.run(TestThread.java:</code><code class="java value">31</code><code class="java plain">) </code></div><div class="line number4 index3 alt1"><code class="java plain">- waiting to lock &lt;</code><code class="java value">0x22c19f18</code><code class="java plain">&gt; (a java.lang.Object) </code></div><div class="line number5 index4 alt2"><code class="java plain">- locked &lt;</code><code class="java value">0x22c19f20</code><code class="java plain">&gt; (a java.lang.Object) </code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="java string">"Thread-0"</code> <code class="java plain">prio=</code><code class="java value">5</code> <code class="java plain">tid=</code><code class="java value">0x00accdb0</code> <code class="java plain">nid=</code><code class="java value">0xdec</code> <code class="java plain">waiting </code><code class="java keyword">for</code> <code class="java plain">monitor entry [</code><code class="java value">0x02cff000</code></div><div class="line number8 index7 alt1"><code class="java plain">..</code><code class="java value">0x02cff9e8</code><code class="java plain">] </code></div><div class="line number9 index8 alt2"><code class="java plain">at deadlockthreads.TestThread.run(TestThread.java:</code><code class="java value">31</code><code class="java plain">) </code></div><div class="line number10 index9 alt1"><code class="java plain">- waiting to lock &lt;</code><code class="java value">0x22c19f20</code><code class="java plain">&gt; (a java.lang.Object) </code></div><div class="line number11 index10 alt2"><code class="java plain">- locked &lt;</code><code class="java value">0x22c19f18</code><code class="java plain">&gt; (a java.lang.Object) </code></div></div></td></tr></tbody></table></div></div>

<p>在 JAVA 5 中加强了对死锁的检测。线程 Dump 中可以直接报告出 Java 级别的死锁，如下所示：</p>

<div><div class="syntaxhighlighter  java" id="highlighter_734812"><div class="toolbar"><span><a class="toolbar_item command_help help" href="#">?</a></span></div><table border="0" cellspacing="0" cellpadding="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="java plain">Found one Java-level deadlock: </code></div><div class="line number2 index1 alt1"><code class="java plain">============================= </code></div><div class="line number3 index2 alt2"><code class="java string">"Thread-1"</code><code class="java plain">: </code></div><div class="line number4 index3 alt1"><code class="java plain">waiting to lock monitor </code><code class="java value">0x0003f334</code> <code class="java plain">(object </code><code class="java value">0x22c19f18</code><code class="java plain">, a java.lang.Object), </code></div><div class="line number5 index4 alt2"><code class="java plain">which is held by </code><code class="java string">"Thread-0"</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="java string">"Thread-0"</code><code class="java plain">: </code></div><div class="line number8 index7 alt1"><code class="java plain">waiting to lock monitor </code><code class="java value">0x0003f314</code> <code class="java plain">(object </code><code class="java value">0x22c19f20</code><code class="java plain">, a java.lang.Object), </code></div><div class="line number9 index8 alt2"><code class="java plain">which is held by </code><code class="java string">"Thread-1"</code></div></div></td></tr></tbody></table></div></div>

<h6 id="33">3.3 热锁</h6>

<p>热锁，也往往是导致系统性能瓶颈的主要因素。<strong>其表现特征为：由于多个线程对临界区，或者锁的竞争</strong>，可能出现：</p>

<ul>
<li><p><strong>频繁的线程的上下文切换</strong>：从操作系统对线程的调度来看，当线程在等待资源而阻塞的时候，操作系统会将之切换出来，放到等待的队列，当线程获得资源之后，调度算法会将这个线程切换进去，放到执行队列中。</p></li>
<li><p><strong>大量的系统调用</strong>：因为线程的上下文切换，以及热锁的竞争，或者临界区的频繁的进出，都可能导致大量的系统调用。</p></li>
<li><p><strong>大部分 CPU 开销用在“系统态”</strong>：线程上下文切换，和系统调用，都会导致 CPU 在 “系统态 ”运行，换而言之，虽然系统很忙碌，但是 CPU 用在 “用户态 ”的比例较小，应用程序得不到充分的 CPU 资源。</p></li>
<li><p><strong>随着 CPU 数目的增多，系统的性能反而下降</strong>。因为 CPU 数目多，同时运行的线程就越多，可能就会造成更频繁的线程上下文切换和系统态的 CPU 开销，从而导致更糟糕的性能。</p></li>
</ul>

<p>上面的描述，都是一个 scalability（可扩展性）很差的系统的表现。从整体的性能指标看，由于线程热锁的存在，程序的响应时间会变长，吞吐量会降低。</p>

<p><strong>那么，怎么去了解 “热锁 ”出现在什么地方呢？</strong></p>

<p>一个重要的方法是<strong>结合操作系统的各种工具观察系统资源使用状况，以及收集 Java 线程的 DUMP 信息，看线程都阻塞在什么方法上</strong>，了解原因，才能找到对应的解决方法。</p>

<h5 id="4jvm">4 JVM 重要线程</h5>

<p>JVM 运行过程中产生的一些比较重要的线程罗列如下：</p>

<p><textarea style="width: 944.99px; height: 878px; -ms-overflow-x: hidden; -ms-overflow-y: hidden; -ms-word-wrap: break-word;" zoom="8.2">╔═════════════════════════════════╤══════╤════════════════════════════════════════════════════════════════════════╗
║ 线程名称                        │ 所属 │ 解释说明                                                               ║
╟─────────────────────────────────┼──────┼────────────────────────────────────────────────────────────────────────╢
║ Attach Listener                 │ JVM  │ Attach Listener 线程是负责接收到外部的命令，而对该命令进行执           ║
║                                 │      │ 行的并把结果返回给发送者。通常我们会用一些命令去要求 JVM 给            ║
║                                 │      │ 我们一些反馈信息，如：java -version、jmap、jstack等等。 如果该         ║
║                                 │      │ 线程在 JVM 启动的时候没有初始化，那么，则会在用户第一次执行            ║
║                                 │      │  JVM 命令时，得到启动。                                                ║
╟─────────────────────────────────┼──────┼────────────────────────────────────────────────────────────────────────╢
║ Signal Dispatcher               │ JVM  │ 前面提到 Attach Listener 线程的职责是接收外部 JVM 命令，当命令         ║
║                                 │      │ 接收成功后，会交给 signal dispather 线程去进行分发到各个不同的         ║
║                                 │      │ 模块处理命令，并且返回处理结果。signal dispather 线程也是在第          ║
║                                 │      │ 一次接收外部 JVM 命令时，进行初始化工作。                              ║
╟─────────────────────────────────┼──────┼────────────────────────────────────────────────────────────────────────╢
║ CompilerThread0                 │ JVM  │ 用来调用 JITing，实时编译装卸 Class 。通常，JVM 会启动多个线           ║
║                                 │      │ 程来处理这部分工作，线程名称后面的数字也会累加，例                     ║
║                                 │      │ 如：CompilerThread1。                                                  ║
╟─────────────────────────────────┼──────┼────────────────────────────────────────────────────────────────────────╢
║ Concurrent Mark-Sweep GC Thread │ JVM  │ 并发标记清除垃圾回收器（就是通常所说的 CMS GC）线程， 该线             ║
║                                 │      │ 程主要针对于老年代垃圾回收。ps：启用该垃圾回收器，需要在               ║
║                                 │      │  JVM 启动参数中加上：-XX:+UseConcMarkSweepGC。                         ║
╟─────────────────────────────────┼──────┼────────────────────────────────────────────────────────────────────────╢
║ DestroyJavaVM                   │ JVM  │ 执行 main() 的线程，在 main 执行完后调用 JNI 中的                      ║
║                                 │      │ jni_DestroyJavaVM() 方法唤起 DestroyJavaVM 线程，处于等待状态，        ║
║                                 │      │ 等待其它线程（Java 线程和 Native 线程）退出时通知它卸载 JVM。          ║
║                                 │      │ 每个线程退出时，都会判断自己当前是否是整个 JVM 中最后一个              ║
║                                 │      │ 非 deamon 线程，如果是，则通知 DestroyJavaVM 线程卸载 JVM。            ║
╟─────────────────────────────────┼──────┼────────────────────────────────────────────────────────────────────────╢
║ Finalizer Thread                │ JVM  │ 这个线程也是在 main 线程之后创建的，其优先级为 10，主要用于            ║
║                                 │      │ 在垃圾收集前，调用对象的 finalize()方法；关于 Finalizer 线程的         ║
║                                 │      │ 几点：                                                                 ║
║                                 │      │                                                                        ║
║                                 │      │   1) 只有当开始一轮垃圾收集时，才会开始调用 finalize() 方法；          ║
║                                 │      │ 因此并不是所有对象的 finalize() 方法都会被执行；                       ║
║                                 │      │                                                                        ║
║                                 │      │   2) 该线程也是 daemon 线程，因此如果虚拟机中没有其他非                ║
║                                 │      │  daemon 线程，不管该线程有没有执行完 finalize() 方法，JVM 也会退出；   ║
║                                 │      │                                                                        ║
║                                 │      │   3) JVM 在垃圾收集时会将失去引用的对象包装成 Finalizer 对象           ║
║                                 │      │ （Reference 的实现），并放入 ReferenceQueue，由 Finalizer 线程来处理； ║
║                                 │      │ 最后将该 Finalizer 对象的引用置为 null，由垃圾收集器来回收；           ║
║                                 │      │                                                                        ║
║                                 │      │   4) JVM 为什么要单独用一个线程来执行 finalize()方法呢？如果           ║
║                                 │      │  JVM 的垃圾收集线程自己来做，很有可能由于在 finalize() 方法中误操作    ║
║                                 │      │ 导致 GC 线程停止或不可控，这对 GC 线程来说是一种灾难；                 ║
╟─────────────────────────────────┼──────┼────────────────────────────────────────────────────────────────────────╢
║ Low Memory Detector             │ JVM  │ 这个线程是负责对可使用内存进行检测，如果发现可用内存低，分             ║
║                                 │      │ 配新的内存空间。                                                       ║
╟─────────────────────────────────┼──────┼────────────────────────────────────────────────────────────────────────╢
║ Reference Handler               │ JVM  │ JVM 在创建 main 线程后就创建 Reference Handler 线程，其优先级最        ║
║                                 │      │ 高，为 10，它主要用于处理引用对象本身（软引用、弱引用、虚引            ║
║                                 │      │ 用）的垃圾回收问题 。                                                  ║
╟─────────────────────────────────┼──────┼────────────────────────────────────────────────────────────────────────╢
║ VM Thread                       │ JVM  │ 这个线程就比较牛 b 了，是 JVM 里面的线程母体，根据 hotspot 源          ║
║                                 │      │ 码（vmThread.hpp）里面的注释，它是一个单个的对象（最原始的             ║
║                                 │      │ 线程）会产生或触发所有其他的线程，这个单个的 VM 线程是会被             ║
║                                 │      │ 其他线程所使用来做一些VM操作（如：清扫垃圾等）。                       ║
╚═════════════════════════════════╧══════╧════════════════════════════════════════════════════════════════════════╝</textarea></p>

<pre><code class="hljs javascript">[<span class="hljs-string"><span class="hljs-string">"线程名称"</span></span>,<span class="hljs-string"><span class="hljs-string">"所属"</span></span>,<span class="hljs-string"><span class="hljs-string">"解释说明"</span></span>],
[<span class="hljs-string"><span class="hljs-string">"Attach Listener"</span></span>,<span class="hljs-string"><span class="hljs-string">"JVM"</span></span>,<span class="hljs-string"><span class="hljs-string">"Attach Listener 线程是负责接收到外部的命令，而对该命令进行执\n行的并把结果返回给发送者。通常我们会用一些命令去要求 JVM 给\n我们一些反馈信息，如：java -version、jmap、jstack等等。 如果该\n线程在 JVM 启动的时候没有初始化，那么，则会在用户第一次执行\n JVM 命令时，得到启动。"</span></span>],
[<span class="hljs-string"><span class="hljs-string">"Signal Dispatcher"</span></span>,<span class="hljs-string"><span class="hljs-string">"JVM"</span></span>,<span class="hljs-string"><span class="hljs-string">"前面提到 Attach Listener 线程的职责是接收外部 JVM 命令，当命令\n接收成功后，会交给 signal dispather 线程去进行分发到各个不同的\n模块处理命令，并且返回处理结果。signal dispather 线程也是在第\n一次接收外部 JVM 命令时，进行初始化工作。"</span></span>],
[<span class="hljs-string"><span class="hljs-string">"CompilerThread0"</span></span>,<span class="hljs-string"><span class="hljs-string">"JVM"</span></span>,<span class="hljs-string"><span class="hljs-string">"用来调用 JITing，实时编译装卸 Class 。通常，JVM 会启动多个线\n程来处理这部分工作，线程名称后面的数字也会累加，例\n如：CompilerThread1。"</span></span>],
[<span class="hljs-string"><span class="hljs-string">"Concurrent Mark-Sweep GC Thread"</span></span>,<span class="hljs-string"><span class="hljs-string">"JVM"</span></span>,<span class="hljs-string"><span class="hljs-string">"并发标记清除垃圾回收器（就是通常所说的 CMS GC）线程， 该线\n程主要针对于老年代垃圾回收。ps：启用该垃圾回收器，需要在\n JVM 启动参数中加上：-XX:+UseConcMarkSweepGC。"</span></span>],
[<span class="hljs-string"><span class="hljs-string">"DestroyJavaVM"</span></span>,<span class="hljs-string"><span class="hljs-string">"JVM"</span></span>,<span class="hljs-string"><span class="hljs-string">"执行 main() 的线程，在 main 执行完后调用 JNI 中的 \njni_DestroyJavaVM() 方法唤起 DestroyJavaVM 线程，处于等待状态，\n等待其它线程（Java 线程和 Native 线程）退出时通知它卸载 JVM。\n每个线程退出时，都会判断自己当前是否是整个 JVM 中最后一个\n非 deamon 线程，如果是，则通知 DestroyJavaVM 线程卸载 JVM。"</span></span>],
[<span class="hljs-string"><span class="hljs-string">"Finalizer Thread"</span></span>,<span class="hljs-string"><span class="hljs-string">"JVM"</span></span>,<span class="hljs-string"><span class="hljs-string">"这个线程也是在 main 线程之后创建的，其优先级为 10，主要用于\n在垃圾收集前，调用对象的 finalize()方法；关于 Finalizer 线程的\n几点：\n\n  1) 只有当开始一轮垃圾收集时，才会开始调用 finalize() 方法；\n因此并不是所有对象的 finalize() 方法都会被执行；\n\n  2) 该线程也是 daemon 线程，因此如果虚拟机中没有其他非\n daemon 线程，不管该线程有没有执行完 finalize() 方法，JVM 也会退出；\n\n  3) JVM 在垃圾收集时会将失去引用的对象包装成 Finalizer 对象\n（Reference 的实现），并放入 ReferenceQueue，由 Finalizer 线程来处理；\n最后将该 Finalizer 对象的引用置为 null，由垃圾收集器来回收；\n\n  4) JVM 为什么要单独用一个线程来执行 finalize()方法呢？如果\n JVM 的垃圾收集线程自己来做，很有可能由于在 finalize() 方法中误操作\n导致 GC 线程停止或不可控，这对 GC 线程来说是一种灾难；"</span></span>],
[<span class="hljs-string"><span class="hljs-string">"Low Memory Detector"</span></span>,<span class="hljs-string"><span class="hljs-string">"JVM"</span></span>,<span class="hljs-string"><span class="hljs-string">"这个线程是负责对可使用内存进行检测，如果发现可用内存低，分\n配新的内存空间。"</span></span>],
[<span class="hljs-string"><span class="hljs-string">"Reference Handler"</span></span>,<span class="hljs-string"><span class="hljs-string">"JVM"</span></span>,<span class="hljs-string"><span class="hljs-string">"JVM 在创建 main 线程后就创建 Reference Handler 线程，其优先级最\n高，为 10，它主要用于处理引用对象本身（软引用、弱引用、虚引\n用）的垃圾回收问题 。"</span></span>],
[<span class="hljs-string"><span class="hljs-string">"VM Thread"</span></span>,<span class="hljs-string"><span class="hljs-string">"JVM"</span></span>,<span class="hljs-string"><span class="hljs-string">"这个线程就比较牛 b 了，是 JVM 里面的线程母体，根据 hotspot 源\n码（vmThread.hpp）里面的注释，它是一个单个的对象（最原始的\n线程）会产生或触发所有其他的线程，这个单个的 VM 线程是会被\n其他线程所使用来做一些VM操作（如：清扫垃圾等）。"</span></span>]
</code></pre>

<p>参考链接：</p>

<ul>
<li><a href="https://juejin.im/post/5b31b510e51d4558a426f7e9" target="_blank">啃碎并发（四）：Java 线程 Dump 分析</a></li>
</ul></body></html>